'use client';

import React, { useState, useEffect, useRef } from 'react';
import { useRouter, useSearchParams } from 'next/navigation';
import { ArrowLeft, Save, Printer, ChevronDown, Plus, Trash2 } from 'lucide-react';
import { formatNumber } from '@/lib/utils';
import { Skeleton } from '@/components/Skeleton';
import { SearchableSelect } from '@/components/ui/SearchableSelect';
import { Layout } from '@/components/Layout';

interface InvoiceItem {
    id: number;
    itemId: number;
    productMasterCode: string;
    productCode: string;
    itemName: string;
    itemCode: string;
    jobName: string;
    narration: string;
    description: string;
    isService: 'Yes' | 'No';
    productHSNID: number;
    productHSNName: string;
    hsnCode: string;
    freeQuantity: number;
    quantity: number;
    rate: number;
    unit: string;
    discountPercent: number;
    discountAmount: number;
    basicAmount: number;
    taxRate: number;
    gstTaxPercentage: number;
    cgstTaxPercentage: number;
    sgstTaxPercentage: number;
    igstTaxPercentage: number;
    taxAmount: number;
    cgstAmt: number;
    sgstAmt: number;
    igstAmt: number;
    taxableAmount: number;
    amount: number;
    packingReference: string;
    noOfPallet: number;
    issueOuterCarton: number;
    innerCarton: number;
    netWeight: number;
    grossWeight: number;
    poNo: string;
    poDate: string;
    salesOrderNo: string;
    jobBookingNo: string;
    deliveryNoteNo: string;
    deliveryNoteDate: string;
    batchName: string;
    batchNo: string;
    supplierBatchNo: string;
    transactionID: string;
    stockQty?: number;
    wtPerPacking?: number; // Weight per piece for PCS items
    originalStockUnit?: string; // Original stock unit from database
    originalStockQty?: number; // Original stock quantity in stock unit
    sizeL?: number;
    sizeW?: number;
    gsm?: number;
}

interface TaxCalculationRow {
    id: number;
    ledgerId: string;
    ledgerName: string;
    taxRate: number;
    calculationOn: 'Value' | 'Quantity';
    gstType?: string; // Type of GST: CGST, SGST, IGST
    gstApplicable: boolean;
    inAmount: number;
    amount: number;
    isManualAmount: boolean; // If true, user can manually enter amount
    isAutoGenerated?: boolean; // If true, this row was auto-generated from GST calculation
}

interface Client {
    LedgerID: number;
    LedgerName: string;
    TradeName?: string;
    Country?: string;
    State?: string;
    contacts?: any[];
    GSTApplicable?: boolean;
    GSTNo?: string;
    ClientStateTinNo?: string;
    CompanyStateTinNo?: string;
}

interface Consignee {
    LedgerID: number;
    LedgerName: string;
    TradeName?: string;
    Destination?: string;
    State?: string;
}

export const ScrapInvoice: React.FC = () => {
    const router = useRouter();
    const searchParams = useSearchParams();
    const selectedItemIds = searchParams.get('items')?.split(',').map(Number) || [];
    const editInvoiceId = searchParams.get('edit') ? Number(searchParams.get('edit')) : (searchParams.get('id') ? Number(searchParams.get('id')) : null);

    const [loading, setLoading] = useState(true);
    const [saving, setSaving] = useState(false);
    const [saveSuccess, setSaveSuccess] = useState('');
    const [selectedItems, setSelectedItems] = useState<any[]>([]);
    const [isEditMode, setIsEditMode] = useState(false);
    const [editingInvoiceId, setEditingInvoiceId] = useState<number | null>(null);

    // Dropdown data
    const [clients, setClients] = useState<Client[]>([]);
    const [consignees, setConsignees] = useState<Consignee[]>([]);
    const [salesLedgers, setSalesLedgers] = useState<any[]>([]);
    const [transporters, setTransporters] = useState<any[]>([]);
    const [itemsList, setItemsList] = useState<any[]>([]);
    const [taxLedgers, setTaxLedgers] = useState<any[]>([]);

    // New Invoice API dropdown data
    const [voucherTypes, setVoucherTypes] = useState<any[]>([]);
    const [hsnGroups, setHsnGroups] = useState<any[]>([]);

    // GST configuration
    const [companyGSTApplicable, setCompanyGSTApplicable] = useState(false);
    const [companyStateTinNo, setCompanyStateTinNo] = useState('0');
    const [clientGSTApplicable, setClientGSTApplicable] = useState(false);
    const [clientStateTinNo, setClientStateTinNo] = useState('0');
    const [voucherGSTApplicable, setVoucherGSTApplicable] = useState(false);

    // Scrap Selection Modal State
    const [showScrapModal, setShowScrapModal] = useState(false);
    const [scrapItems, setScrapItems] = useState<any[]>([]);

    // Form state
    const [formData, setFormData] = useState({
        voucherType: '',
        voucherId: 0,
        prefix: '',
        documentType: 'INV',
        invoiceType: 'Scrap',
        isExport: 'no',
        currency: 'INR',
        conversionRate: 1,
        clientId: '',
        clientName: '',
        country: '',
        state: '',
        tradeName: '',
        salesLedgerId: '',
        invoiceNo: '',
        invoiceDate: new Date().toISOString().split('T')[0],
        consigneeId: '',
        consigneeTradeName: '',
        destination: '',
        shippedFrom: '',
        igstOnIntra: 'no',
        eCommerce: 'no',
        freight: 'Paid',
        reverseCharge: 'no',
        basicAmount: 0,
        totalTax: 0,
        tcsPercent: 0,
        tcsAmount: 0,
        roundOffAc: 0,
        netAmount: 0,
        totalDispatchedQty: 0,
        netWeight: 0,
        grossWeight: 0,
        remark: '',
        invoiceRefNo: '',
        transporterId: '',
        transporter: '',
        vehicleNo: '',
        modeOfTransport: '',
        podNo: '',
        distance: '',
        eWayBill: '',
        eWayBillDate: '',
        paymentTerms: ''
    });

    const [invoiceItems, setInvoiceItems] = useState<InvoiceItem[]>([]);
    const [taxCalculationRows, setTaxCalculationRows] = useState<TaxCalculationRow[]>([]);
    const [selectedTaxLedger, setSelectedTaxLedger] = useState<string>('');
    const [validationError, setValidationError] = useState<string | null>(null);

    // Determine if Inter-state or Intra-state
    const isInterState = React.useMemo(() => {
        // If we have TINs, use them
        if (companyStateTinNo && clientStateTinNo && companyStateTinNo !== '0' && clientStateTinNo !== '0') {
            const companyStateCode = companyStateTinNo.substring(0, 2);
            const clientStateCode = clientStateTinNo.substring(0, 2);
            return companyStateCode !== clientStateCode;
        }
        // Fallback to names if TINs missing (less reliable)
        // companyState is currently hardcoded in the effect, let's assume Gujarat for now as per code
        const companyState = 'Gujarat';
        return formData.state && formData.state.toLowerCase() !== companyState.toLowerCase();
    }, [formData.state, companyStateTinNo, clientStateTinNo]);

    // Column resize functionality
    const tableRef = useRef<HTMLTableElement>(null);
    const resizingColumn = useRef<{ columnIndex: number, startX: number, startWidth: number } | null>(null);

    const handleMouseDown = (e: React.MouseEvent, columnIndex: number) => {
        if (!tableRef.current) return;

        const th = tableRef.current.querySelectorAll('th')[columnIndex];
        if (!th) return;

        resizingColumn.current = {
            columnIndex,
            startX: e.clientX,
            startWidth: th.offsetWidth
        };

        e.preventDefault();
    };

    useEffect(() => {
        const handleMouseMove = (e: MouseEvent) => {
            if (!resizingColumn.current || !tableRef.current) return;

            const { columnIndex, startX, startWidth } = resizingColumn.current;
            const diff = e.clientX - startX;
            const newWidth = Math.max(50, startWidth + diff); // Minimum 50px

            const th = tableRef.current.querySelectorAll('th')[columnIndex];
            if (th) {
                th.style.width = `${newWidth}px`;
                th.style.minWidth = `${newWidth}px`;
                th.style.maxWidth = `${newWidth}px`;
            }
        };

        const handleMouseUp = () => {
            resizingColumn.current = null;
        };

        document.addEventListener('mousemove', handleMouseMove);
        document.addEventListener('mouseup', handleMouseUp);

        return () => {
            document.removeEventListener('mousemove', handleMouseMove);
            document.removeEventListener('mouseup', handleMouseUp);
        };
    }, []);

    useEffect(() => {
        fetchInitialData();
    }, []);

    const fetchInitialData = async () => {
        try {
            setLoading(true);

            // 1. Fetch all reference data first
            const { scrapApi } = await import('@/lib/api');

            // Fetch HSN groups first to map them to items
            const hsnGroupsResult = await scrapApi.getInvoiceHSNGroups();
            let loadedHsnGroups: any[] = [];
            if (hsnGroupsResult.success && hsnGroupsResult.data && Array.isArray(hsnGroupsResult.data)) {
                loadedHsnGroups = hsnGroupsResult.data;
                setHsnGroups(loadedHsnGroups);
            }

            // Fetch other reference data in parallel
            await Promise.all([
                fetchClients(),
                fetchSalesLedgers(),
                fetchTaxLedgers(),
                fetchTransporters(),
                fetchVoucherTypes(),
                fetchCompanyGST(),
                fetchItemsList() // Fetch all items for the dropdown
            ]);

            // 2. Fetch selected stock items and map them
            if (selectedItemIds.length > 0) {
                const stockResult = await scrapApi.getStock();

                if (stockResult.success && stockResult.data) {
                    const data: any = stockResult.data;
                    const items = data.filter((item: any) =>
                        selectedItemIds.includes(item.itemId)
                    );
                    setSelectedItems(items);

                    // Initialize invoice items with HSN mapping
                    const initItems: InvoiceItem[] = await Promise.all(items.map(async (item: any, index: number) => {
                        // Try to find matching HSN Group
                        // Check by ID first (ProductHSNID), then by Name match if needed
                        let hsnGroup = null;

                        if (item.productHSNID) {
                            hsnGroup = loadedHsnGroups.find(g => g.productHSNID === item.productHSNID);
                        }

                        // Fallback: Try to match by HSN Name or Code if available
                        if (!hsnGroup && item.hsnCode) {
                            hsnGroup = loadedHsnGroups.find(g => g.hsnCode === item.hsnCode);
                        }

                        // Defaults if no HSN group found
                        const hsnName = hsnGroup?.productHSNName || item.productHSNName || '';
                        const hsnCode = hsnGroup?.hsnCode || item.hsnCode || '';
                        const cgstRate = hsnGroup?.cgstTaxPercentage || item.cgstTaxPercentage || 0;
                        const sgstRate = hsnGroup?.sgstTaxPercentage || item.sgstTaxPercentage || 0;
                        const igstRate = hsnGroup?.igstTaxPercentage || item.igstTaxPercentage || 0;

                        // Fetch batch details for the item
                        let batchDetails: any = { TransactionID: 0, BatchNo: '', SupplierBatchNo: '', BatchName: '' };
                        try {
                            const batchRes = await scrapApi.getItemBatchDetails(item.itemId);
                            if (batchRes.success && batchRes.data) {
                                batchDetails = batchRes.data;
                            }
                        } catch (err) {
                            console.error("Failed to fetch batch details for item", item.itemId, err);
                        }

                        return {
                            id: index + 1,
                            itemId: item.itemId,
                            productMasterCode: item.productMasterCode || '',
                            productCode: item.productCode || '',
                            itemName: item.itemName,
                            itemCode: item.itemCode,
                            jobName: '',
                            narration: '',
                            description: '',
                            isService: 'No',
                            productHSNName: hsnName,
                            hsnCode: hsnCode,
                            freeQuantity: 0,
                            // Store original stock values
                            originalStockUnit: item.stockUnit || 'KG',
                            originalStockQty: item.netStock || item.PhysicalStock || 0,
                            wtPerPacking: item.wtPerPacking || 0,
                            // For PCS items, convert to KG for invoice by default
                            // For other items, use original unit
                            quantity: (item.stockUnit?.toUpperCase() === 'PCS' && item.wtPerPacking)
                                ? (item.netStock || item.PhysicalStock || 0) * item.wtPerPacking  // Convert PCS to KG
                                : (item.netStock || item.PhysicalStock || 0),
                            rate: 0,
                            unit: (item.stockUnit?.toUpperCase() === 'PCS') ? 'KG' : (item.stockUnit || 'KG'), // Default to KG for PCS items
                            discountPercent: 0,
                            discountAmount: 0,
                            basicAmount: 0,
                            taxRate: cgstRate + sgstRate, // For display only
                            gstTaxPercentage: cgstRate + sgstRate, // Total Tax %
                            cgstTaxPercentage: cgstRate,
                            sgstTaxPercentage: sgstRate,
                            igstTaxPercentage: igstRate,
                            taxAmount: 0,
                            cgstAmt: 0,
                            sgstAmt: 0,
                            igstAmt: 0,
                            taxableAmount: 0,
                            amount: 0,
                            packingReference: '',
                            noOfPallet: 0,
                            issueOuterCarton: 0,
                            innerCarton: 0,
                            // Auto-fill weights - always use KG value
                            netWeight: (item.stockUnit?.toUpperCase() === 'PCS' && item.wtPerPacking)
                                ? (item.netStock || item.PhysicalStock || 0) * item.wtPerPacking
                                : ((item.stockUnit === 'KG' || item.unit === 'KG') ? (item.netStock || item.PhysicalStock || 0) : 0),
                            grossWeight: (item.stockUnit?.toUpperCase() === 'PCS' && item.wtPerPacking)
                                ? (item.netStock || item.PhysicalStock || 0) * item.wtPerPacking
                                : ((item.stockUnit === 'KG' || item.unit === 'KG') ? (item.netStock || item.PhysicalStock || 0) : 0),
                            poNo: '',
                            poDate: '',
                            salesOrderNo: '',
                            jobBookingNo: '',
                            deliveryNoteNo: '',
                            deliveryNoteDate: '',
                            batchName: batchDetails.BatchName || batchDetails.BatchNo || '',
                            batchNo: batchDetails.BatchNo || '',
                            supplierBatchNo: batchDetails.SupplierBatchNo || '',
                            transactionID: batchDetails.TransactionID ? batchDetails.TransactionID.toString() : ''
                        };
                    }));
                    setInvoiceItems(initItems);
                }
            }

            // Check if we're in edit mode
            if (editInvoiceId) {
                await loadInvoiceForEdit(editInvoiceId);
            } else {
                // Generate invoice number only for new invoices
                generateInvoiceNumber();
            }

        } catch (error) {
            console.error('Error fetching initial data:', error);
        } finally {
            setLoading(false);
        }
    };

    // Load invoice data for editing
    const loadInvoiceForEdit = async (invoiceId: number) => {
        try {
            const { scrapApi } = await import('@/lib/api');
            const result = await scrapApi.getInvoiceById(invoiceId);

            if (result.success && result.data) {
                const { MainData, Items, Taxes } = result.data as any;

                setIsEditMode(true);
                setEditingInvoiceId(invoiceId);

                // Populate form data
                setFormData({
                    ...formData,
                    voucherId: MainData.InvoiceTransactionID || 0,
                    prefix: MainData.VoucherPrefix || '',
                    documentType: MainData.DocumentType || 'INV',
                    invoiceType: MainData.InvoiceType || 'Scrap',
                    isExport: MainData.IsExport ? 'yes' : 'no',
                    currency: MainData.CurrencyCode || 'INR',
                    conversionRate: MainData.CurrConversionValue || 1,
                    clientId: MainData.LedgerID?.toString() || '',
                    clientName: MainData.ClientName || '',
                    country: MainData.OriginCountry || '',
                    salesLedgerId: MainData.SalesLedgerID?.toString() || '',
                    invoiceNo: MainData.VoucherNo || '',
                    invoiceDate: MainData.VoucherDate || new Date().toISOString().split('T')[0],
                    consigneeId: MainData.ConsigneeLedgerID?.toString() || '',
                    destination: MainData.Destination || '',
                    shippedFrom: MainData.ShippedFrom || '',
                    igstOnIntra: MainData.IGSTOnIntra ? 'yes' : 'no',
                    eCommerce: MainData.ECommerce ? 'yes' : 'no',
                    reverseCharge: MainData.ReverseCharge ? 'yes' : 'no',
                    basicAmount: MainData.TotalBasicAmount || 0,
                    totalTax: MainData.TotalTaxAmount || 0,
                    roundOffAc: MainData.RoundOffTax || 0,
                    netAmount: MainData.NetAmount || 0,
                    netWeight: MainData.NetWeight || 0,
                    grossWeight: MainData.GrossWeight || 0,
                    remark: MainData.Narration || '',
                    invoiceRefNo: MainData.InvoiceReferenceNo || '',
                    transporterId: MainData.TransporterID?.toString() || '',
                    vehicleNo: MainData.VehicleNo || '',
                    podNo: MainData.PODNo || '',
                    distance: MainData.TotalDistance || '',
                    eWayBill: MainData.EWayBillNumber || '',
                    eWayBillDate: MainData.EWayBillDate || '',
                    paymentTerms: MainData.PaymentTerms || '',
                });

                // Fetch consignees for the client
                if (MainData.LedgerID) {
                    await fetchConsignees(MainData.LedgerID);
                }

                // Load invoice items
                if (Items && Items.length > 0) {
                    const loadedItems: InvoiceItem[] = Items.map((item: any, index: number) => ({
                        id: index + 1,
                        itemId: item.ItemID || 0,
                        productMasterCode: '',
                        productCode: item.ProductCode || '',
                        itemName: item.ItemName || '',
                        itemCode: item.ItemCode || '',
                        jobName: item.JobName || '',
                        narration: item.ProductNarration || '',
                        description: '',
                        isService: item.IsService || 'No',
                        productHSNName: '',
                        hsnCode: '',
                        freeQuantity: 0,
                        quantity: item.Quantity || 0,
                        rate: item.Rate || 0,
                        unit: item.RateType || 'KG',
                        discountPercent: item.DiscountPercentage || 0,
                        discountAmount: item.DiscountAmount || 0,
                        basicAmount: item.BasicAmount || 0,
                        taxRate: item.GSTPercentage || 0,
                        taxableAmount: item.TaxableAmount || 0,
                        gstTaxPercentage: item.GSTPercentage || 0,
                        cgstTaxPercentage: item.CGSTPercentage || 0,
                        sgstTaxPercentage: item.SGSTPercentage || 0,
                        igstTaxPercentage: item.IGSTPercentage || 0,
                        cgstAmt: item.CGSTAmount || 0,
                        sgstAmt: item.SGSTAmount || 0,
                        igstAmt: item.IGSTAmount || 0,
                        amount: item.NetAmount || 0,
                        netWeight: item.NetWeight || 0,
                        grossWeight: item.GrossWeight || 0,
                        poNo: item.PONo || '',
                        poDate: item.PODate || '',
                        salesOrderNo: '',
                        jobBookingNo: '',
                        deliveryNoteNo: '',
                        deliveryNoteDate: '',
                        packingReference: item.PackingReference || '',
                        noOfPallet: item.NoOfPallet || 0,
                        issueOuterCarton: item.IssueOuterCarton || 0,
                        innerCarton: item.InnerCarton || 0,
                        batchName: '',
                        batchNo: '',
                        supplierBatchNo: '',
                        transactionID: ''
                    }));
                    setInvoiceItems(loadedItems);
                }

                // Load tax rows
                if (Taxes && Taxes.length > 0) {
                    const loadedTaxes = Taxes.map((tax: any, tIndex: number) => ({
                        id: tax.InvoiceTransactionTaxesID || `tax-row-${tIndex}`,
                        ledgerId: tax.LedgerID?.toString() || '',
                        ledgerName: '', // Will be populated from taxLedgers
                        taxRate: tax.TaxPercentage || 0,
                        calculationOn: tax.CalculatedON || 'Basic Amount',
                        inAmount: tax.TaxInAmount || 0,
                        amount: tax.Amount || 0,
                        gstApplicable: tax.GSTApplicable || false
                    }));
                    setTaxCalculationRows(loadedTaxes);
                }
            }
        } catch (error) {
            console.error('Error loading invoice for edit:', error);
            alert('Failed to load invoice data');
        }
    };

    const fetchClients = async () => {
        try {
            const { scrapApi } = await import('@/lib/api');

            const result = await scrapApi.getClients();

            if (result.success && result.data && Array.isArray(result.data)) {
                setClients(result.data);
            }
        } catch (error) {
            console.error('Error fetching clients:', error);
        }
    };

    const fetchSalesLedgers = async () => {
        try {
            const { scrapApi } = await import('@/lib/api');

            const result = await scrapApi.getSalesLedgers();

            if (result.success && result.data && Array.isArray(result.data)) {
                setSalesLedgers(result.data);
            }
        } catch (error) {
            console.error('Error fetching sales ledgers:', error);
        }
    };

    const fetchConsignees = async (clientId: number) => {
        try {
            const { scrapApi } = await import('@/lib/api');

            const result = await scrapApi.getConsignees(clientId);

            if (result.success && result.data && Array.isArray(result.data)) {
                setConsignees(result.data);
            }
        } catch (error) {
            console.error('Error fetching consignees:', error);
        }
    };

    const fetchTaxLedgers = async () => {
        try {
            const { scrapApi } = await import('@/lib/api');

            const result = await scrapApi.getTaxLedgers();

            if (result.success && result.data && Array.isArray(result.data)) {
                setTaxLedgers(result.data);
            }
        } catch (error) {
            console.error('Error fetching tax ledgers:', error);
        }
    };

    const fetchVoucherTypes = async () => {
        try {
            const { scrapApi } = await import('@/lib/api');

            const result = await scrapApi.getInvoiceVoucherTypes();

            if (result.success && result.data && Array.isArray(result.data)) {
                setVoucherTypes(result.data);
            }
        } catch (error) {
            console.error('Error fetching voucher types:', error);
        }
    };

    const fetchHSNGroups = async () => {
        try {
            const { scrapApi } = await import('@/lib/api');

            const result = await scrapApi.getInvoiceHSNGroups();

            if (result.success && result.data && Array.isArray(result.data)) {
                setHsnGroups(result.data);
            }
        } catch (error) {
            console.error('Error fetching HSN groups:', error);
        }
    };

    const fetchCompanyGST = async () => {
        try {
            const { scrapApi } = await import('@/lib/api');

            const result = await scrapApi.getInvoiceCompanyGST();

            console.log('ðŸ¢ Company GST API Response:', result);

            if (result.success && result.data) {
                const data: any = result.data;
                console.log('ðŸ¢ Setting Company GST:', {
                    companyGSTApplicable: data.companyGSTApplicable,
                    companyStateTinNo: data.companyStateTinNo
                });
                setCompanyGSTApplicable(data.companyGSTApplicable || false);
                setCompanyStateTinNo(data.companyStateTinNo || '0');
            }
        } catch (error) {
            console.error('âŒ Error fetching company GST config:', error);
        }
    };

    const fetchTransporters = async () => {
        try {
            const { scrapApi } = await import('@/lib/api');

            const transportersRes = await scrapApi.getTransporters();
            if (transportersRes.success && Array.isArray(transportersRes.data)) {
                setTransporters(transportersRes.data);
            }
        } catch (error) {
            console.error('Error fetching transporters:', error);
        }
    };

    const fetchItemsList = async () => {
        try {
            const { scrapApi } = await import('@/lib/api');
            // Use getStock to match Scrap Sales page
            const itemsRes = await scrapApi.getStock();

            if (itemsRes.success && Array.isArray(itemsRes.data)) {
                // Map stock data to a friendly format for the dropdown
                let items = itemsRes.data.map((s: any) => ({
                    ...s,
                    id: s.itemId, // Map itemId to id for consistency
                    ItemID: s.itemId,
                    ItemName: s.itemName,
                    ItemCode: s.itemCode,
                    IsScrap: 1 // Since it comes from Stock/Sales, treat as scrap
                }));

                // Filter items if selectedItemIds are present in the URL
                // Filter removed to allow selecting any scrap item
                // if (selectedItemIds.length > 0) {
                //   items = items.filter((item: any) => selectedItemIds.includes(item.id));
                // }
                console.log("ðŸ“¦ Fetched Stock Items:", items.length);
                setItemsList(items);
            }
        } catch (error) {
            console.error('Error fetching items list:', error);
        }
    };
    const generateInvoiceNumber = () => {
        const date = new Date();
        const year = date.getFullYear().toString().slice(-2);
        const month = (date.getMonth() + 1).toString().padStart(2, '0');
        const random = Math.floor(Math.random() * 9999).toString().padStart(4, '0');
        const invoiceNo = `SCRP${year}${month}${random}`;
        setFormData(prev => ({ ...prev, invoiceNo, invoiceRefNo: invoiceNo }));
    };

    const handleVoucherTypeChange = async (voucherName: string) => {
        setFormData(prev => ({ ...prev, voucherType: voucherName, prefix: '', voucherId: 0 }));

        if (!voucherName) {
            setVoucherGSTApplicable(false);
            // Reset all GST values to 0 when no voucher selected
            setInvoiceItems(prev => prev.map(item => ({
                ...item,
                cgstAmt: 0,
                sgstAmt: 0,
                igstAmt: 0,
                taxAmount: 0
            })));
            return;
        }

        // Find the selected voucher in the voucherTypes array
        const selectedVoucher: any = voucherTypes.find((vt: any) => vt.voucherName === voucherName);

        if (selectedVoucher) {
            setFormData(prev => ({
                ...prev,
                prefix: selectedVoucher.prefix || '',
                voucherId: selectedVoucher.voucherId || 0
            }));
            setVoucherGSTApplicable(selectedVoucher.isGstApplicable || false);

            // Recalculate GST for all items
            setInvoiceItems(prev => prev.map(item => {
                if (item.productHSNName && item.basicAmount > 0) {
                    calculateItemGST(item, item.basicAmount);
                }
                return item;
            }));
        }
    };

    const handleClientChange = async (clientId: string) => {
        const client = clients.find(c => c.LedgerID.toString() === clientId);

        if (client) {
            // Clear consignee data first
            setConsignees([]);
            setFormData(prev => ({
                ...prev,
                clientId,
                clientName: client.LedgerName,
                country: client.Country || '',
                state: client.State || '',
                tradeName: client.TradeName || '',
                // Reset consignee fields
                consigneeId: '',
                consigneeTradeName: '',
                destination: ''
            }));

            // Fetch consignees for this client
            fetchConsignees(client.LedgerID);

            // Set GST info directly from client data
            const isGst = client.GSTApplicable !== undefined ? client.GSTApplicable : false;
            const clientTin = client.ClientStateTinNo || '0';

            console.log('ðŸ‘¤ Client Selected:', client.LedgerName);
            console.log('ðŸ“Š Client GST Info:', { isGst, clientTin });

            setClientGSTApplicable(isGst);
            setClientStateTinNo(clientTin);

            // Recalculation is now handled by the useEffect that watches clientGSTApplicable and clientStateTinNo

        } else {
            // If no client selected, clear everything
            setConsignees([]);
            setFormData(prev => ({
                ...prev,
                clientId: '',
                clientName: '',
                country: '',
                state: '',
                tradeName: '',
                consigneeId: '',
                consigneeTradeName: '',
                destination: ''
            }));
            setClientGSTApplicable(false);
            setClientStateTinNo('0');

            // Reset all GST values to 0 when no client selected
            setInvoiceItems(prev => prev.map(item => ({
                ...item,
                cgstAmt: 0,
                sgstAmt: 0,
                igstAmt: 0,
                taxAmount: 0
            })));
        }
    };

    const handleConsigneeChange = (consigneeId: string) => {
        const consignee = consignees.find(c => c.LedgerID.toString() === consigneeId);

        if (consignee) {
            setFormData(prev => ({
                ...prev,
                consigneeId,
                consigneeTradeName: consignee.TradeName || '',
                destination: consignee.Destination || ''
            }));
        }
    };


    const handleTransporterChange = (transporterId: string) => {
        const transporter = transporters.find(t => t.LedgerID?.toString() === transporterId || t.TransporterID?.toString() === transporterId);

        if (transporter) {
            setFormData(prev => ({
                ...prev,
                transporterId,
                transporter: transporter.TransporterName || transporter.LedgerName || ''
            }));
        }
    };

    const handleHSNGroupChange = async (itemId: number, productHSNName: string) => {
        const hsnGroup: any = hsnGroups.find((g: any) => g.productHSNName === productHSNName);

        if (!hsnGroup) {
            // Clear HSN data if no group selected
            setInvoiceItems(prev => prev.map(item => {
                if (item.id === itemId) {
                    return {
                        ...item,
                        productHSNName: '',
                        hsnCode: '',
                        cgstTaxPercentage: 0,
                        sgstTaxPercentage: 0,
                        igstTaxPercentage: 0,
                        cgstAmt: 0,
                        sgstAmt: 0,
                        igstAmt: 0,
                        taxAmount: 0
                    };
                }
                return item;
            }));
            return;
        }

        // Update item with HSN group data
        setInvoiceItems(prev => prev.map(item => {
            if (item.id === itemId) {
                const updatedItem = {
                    ...item,
                    // Handle both camelCase and PascalCase from API response
                    productHSNID: hsnGroup.productHSNID || hsnGroup.ProductHSNID || 0,
                    productHSNName: hsnGroup.productHSNName,
                    hsnCode: hsnGroup.hsnCode,
                    cgstTaxPercentage: hsnGroup.cgstTaxPercentage || 0,
                    sgstTaxPercentage: hsnGroup.sgstTaxPercentage || 0,
                    igstTaxPercentage: hsnGroup.igstTaxPercentage || 0
                };

                // Calculate GST using the new API
                const taxableAmount = updatedItem.basicAmount || (updatedItem.quantity * updatedItem.rate);
                calculateItemGST(updatedItem, taxableAmount);

                return updatedItem;
            }
            return item;
        }));
    };

    // Recalculate GST for all items when global settings change
    useEffect(() => {
        recalculateAllItemsGST();
    }, [companyGSTApplicable, clientGSTApplicable, voucherGSTApplicable, isInterState]);

    // Sync Tax Summary Table with Calculated Item Taxes
    useEffect(() => {
        if (invoiceItems.length === 0) return;

        // aggregated taxes
        let totalCGST = 0;
        let totalSGST = 0;
        let totalIGST = 0;

        invoiceItems.forEach(item => {
            totalCGST += item.cgstAmt || 0;
            totalSGST += item.sgstAmt || 0;
            totalIGST += item.igstAmt || 0;
        });

        const newTaxRows: TaxCalculationRow[] = [];

        // Helper to find or create ledger row
        // Note: We need real Ledger IDs for these. For now, we'll try to match names from taxLedgers list
        // If not found, we might need a fallback or placeholder. 
        // Assuming 'Output CGST', 'Output SGST', 'Output IGST' exist in taxLedgers.

        if (totalCGST > 0) {
            const ledger = taxLedgers.find(l => l.LedgerName?.toLowerCase().includes('output cgst'));
            if (ledger) {
                newTaxRows.push({
                    id: Date.now() + 1,
                    ledgerId: ledger.LedgerID.toString(),
                    ledgerName: ledger.LedgerName,
                    taxRate: 0, // Mixed rates possible, so 0 or average? Keeping 0 for summary.
                    calculationOn: 'Value',
                    gstApplicable: false, // Tax on Tax usually no
                    inAmount: 0,
                    amount: parseFloat(totalCGST.toFixed(2)),
                    isManualAmount: false,
                    isAutoGenerated: true
                });
            }
        }

        if (totalSGST > 0) {
            const ledger = taxLedgers.find(l => l.LedgerName?.toLowerCase().includes('output sgst'));
            if (ledger) {
                newTaxRows.push({
                    id: Date.now() + 2,
                    ledgerId: ledger.LedgerID.toString(),
                    ledgerName: ledger.LedgerName,
                    taxRate: 0,
                    calculationOn: 'Value',
                    gstApplicable: false,
                    inAmount: 0,
                    amount: parseFloat(totalSGST.toFixed(2)),
                    isManualAmount: false,
                    isAutoGenerated: true
                });
            }
        }

        if (totalIGST > 0) {
            const ledger = taxLedgers.find(l => l.LedgerName?.toLowerCase().includes('output igst'));
            if (ledger) {
                newTaxRows.push({
                    id: Date.now() + 3,
                    ledgerId: ledger.LedgerID.toString(),
                    ledgerName: ledger.LedgerName,
                    taxRate: 0,
                    calculationOn: 'Value',
                    gstApplicable: false,
                    inAmount: 0,
                    amount: parseFloat(totalIGST.toFixed(2)),
                    isManualAmount: false,
                    isAutoGenerated: true
                });
            }
        }

        // Merge with existing manual rows (preserve manual, replace auto)
        setTaxCalculationRows(prev => {
            const manualRows = prev.filter(r => !r.isAutoGenerated);
            return [...manualRows, ...newTaxRows];
        });

    }, [invoiceItems, taxLedgers]);

    const recalculateAllItemsGST = () => {
        setInvoiceItems(prev => prev.map(item => {
            if (item.basicAmount > 0) {
                // We use the synchronous calculation logic here
                const taxableAmount = item.basicAmount;

                // Logic from calculateItemGST (local version)
                let newCgstAmt = 0;
                let newSgstAmt = 0;
                let newIgstAmt = 0;
                let newTaxAmount = 0;

                // Check if GST is applicable
                const isGstEnabled = companyGSTApplicable && clientGSTApplicable && voucherGSTApplicable;

                if (isGstEnabled) {
                    if (isInterState) {
                        // IGST
                        const rate = item.igstTaxPercentage || (item.cgstTaxPercentage + item.sgstTaxPercentage);
                        newIgstAmt = (taxableAmount * rate) / 100;
                    } else {
                        // CGST + SGST
                        newCgstAmt = (taxableAmount * item.cgstTaxPercentage) / 100;
                        newSgstAmt = (taxableAmount * item.sgstTaxPercentage) / 100;
                    }
                    newTaxAmount = newCgstAmt + newSgstAmt + newIgstAmt;
                }

                return {
                    ...item,
                    cgstAmt: parseFloat(newCgstAmt.toFixed(2)),
                    sgstAmt: parseFloat(newSgstAmt.toFixed(2)),
                    igstAmt: parseFloat(newIgstAmt.toFixed(2)),
                    taxAmount: parseFloat(newTaxAmount.toFixed(2)),
                    amount: taxableAmount + parseFloat(newTaxAmount.toFixed(2))
                };
            }
            return item;
        }));
    };

    const calculateItemGST = async (item: InvoiceItem, taxableAmount: number) => {
        // Local calculation instead of API
        console.log('ðŸ”„ Calculating GST locally for item:', item.id);

        let cgstAmt = 0;
        let sgstAmt = 0;
        let igstAmt = 0;
        let taxAmount = 0;

        // Check if Global GST Flags allow calculation
        // Must be true for Company, Client AND Voucher Type
        const isGstEnabled = companyGSTApplicable && clientGSTApplicable && voucherGSTApplicable;

        if (isGstEnabled) {
            if (isInterState) {
                // Inter-state: Calculate IGST
                // Use IGST rate if available, otherwise sum of CGST+SGST (fallback)
                const rate = item.igstTaxPercentage > 0
                    ? item.igstTaxPercentage
                    : (item.cgstTaxPercentage + item.sgstTaxPercentage);

                igstAmt = (taxableAmount * rate) / 100;
            } else {
                // Intra-state: Calculate CGST + SGST
                cgstAmt = (taxableAmount * item.cgstTaxPercentage) / 100;
                sgstAmt = (taxableAmount * item.sgstTaxPercentage) / 100;
            }

            taxAmount = cgstAmt + sgstAmt + igstAmt;
        }

        console.log('âœ… Calculated GST:', { isGstEnabled, isInterState, cgstAmt, sgstAmt, igstAmt, total: taxAmount });

        // Update state
        setInvoiceItems(prev => prev.map(i => {
            if (i.id === item.id) {
                return {
                    ...i,
                    cgstAmt: parseFloat(cgstAmt.toFixed(2)),
                    sgstAmt: parseFloat(sgstAmt.toFixed(2)),
                    igstAmt: parseFloat(igstAmt.toFixed(2)),
                    taxAmount: parseFloat(taxAmount.toFixed(2)),
                    amount: taxableAmount + parseFloat(taxAmount.toFixed(2))
                };
            }
            return i;
        }));
    };


    // Calculate totals whenever items or tax rows change
    useEffect(() => {
        calculateTotals();
    }, [invoiceItems, taxCalculationRows, formData.roundOffAc, formData.tcsPercent, formData.freight]);

    const calculateTotals = () => {
        let basicAmount = 0;
        let totalTax = 0;
        let totalQty = 0;
        let totalNetWeight = 0;
        let totalGrossWeight = 0;

        // Track tax sums for Tax Table
        let sumCGST = 0;
        let sumSGST = 0;
        let sumIGST = 0;
        let maxTaxRate = 0;

        // 1. Sum up Basic Amount and Quantities from Items
        invoiceItems.forEach(item => {
            basicAmount += item.basicAmount || 0;
            totalQty += item.quantity || 0;
            totalNetWeight += item.netWeight || 0;
            totalGrossWeight += item.grossWeight || 0;

            // Calculate Total Tax directly from Items for accuracy of Net Amount
            totalTax += item.taxAmount || 0;

            // Sum individual taxes
            sumCGST += item.cgstAmt || 0;
            sumSGST += item.sgstAmt || 0;
            sumIGST += item.igstAmt || 0;

            // Track max tax rate for Freight/Other Charges tax calculation
            if (item.taxRate > maxTaxRate) maxTaxRate = item.taxRate;
        });

        // Default max tax rate if no items or 0
        if (maxTaxRate === 0) maxTaxRate = 18;

        // 2. Auto-populate Tax Table
        let newTaxRows = [...taxCalculationRows];

        // Calculate Other Charges (Freight, Packing, etc.) from Manual Rows
        // Filter out Auto-Generated rows (CGST/SGST/IGST) to avoid double counting
        const otherCharges = newTaxRows
            .filter(r => !r.isAutoGenerated)
            .reduce((sum, r) => sum + (r.amount || 0), 0);

        const taxableValue = basicAmount + otherCharges;

        // Calculate Tax on Other Charges
        // Logic: Distribute tax on freight based on Interstate or NOT
        let freightCGST = 0, freightSGST = 0, freightIGST = 0;

        if (otherCharges > 0) {
            if (isInterState) {
                freightIGST = (otherCharges * maxTaxRate) / 100;
                sumIGST += freightIGST;
                totalTax += freightIGST;
            } else {
                const halfRate = maxTaxRate / 2;
                freightCGST = (otherCharges * halfRate) / 100;
                freightSGST = (otherCharges * halfRate) / 100;
                sumCGST += freightCGST;
                sumSGST += freightSGST;
                totalTax += (freightCGST + freightSGST);
            }
        }

        // Helper to Find Ledger - Broad matching
        const findLedger = (type: string) => {
            const term = type.toLowerCase();
            // Priority 1: "Output" + Type (e.g. "Output CGST")
            let match = taxLedgers.find(l => {
                const name = l.LedgerName || l.ledgerName || '';
                return name.toLowerCase().includes('output') && name.toLowerCase().includes(term);
            });
            // Priority 2: Just Type (e.g. "CGST") if distinct
            if (!match) {
                match = taxLedgers.find(l => {
                    const name = l.LedgerName || l.ledgerName || '';
                    return name.toLowerCase().includes(term);
                });
            }
            return match;
        };

        // Helper to update/add row
        const updateTaxRow = (type: string, amount: number, taxableAmt: number) => {
            if (amount <= 0) return;

            let ledger = findLedger(type);
            if (!ledger) return;

            const existingIndex = newTaxRows.findIndex(r => r.ledgerId === ledger?.LedgerID.toString());

            if (existingIndex >= 0) {
                // Update existing
                newTaxRows[existingIndex] = {
                    ...newTaxRows[existingIndex],
                    amount: parseFloat(amount.toFixed(2)),
                    inAmount: taxableAmt // Updated Taxable value (Basic + Freight)
                };
            } else {
                // Add new
                newTaxRows.push({
                    id: Date.now() + Math.random(),
                    ledgerId: ledger.LedgerID.toString(),
                    ledgerName: ledger.LedgerName,
                    taxRate: ledger.TaxPercentage || 0,
                    calculationOn: (ledger.GSTCalculationOn || 'Value') as 'Value' | 'Quantity',
                    gstApplicable: ledger.GSTApplicable === 'True' || ledger.GSTApplicable === true,
                    inAmount: taxableAmt,
                    amount: parseFloat(amount.toFixed(2)),
                    isManualAmount: false,
                    isAutoGenerated: true
                });
            }
        };

        if (sumCGST > 0) updateTaxRow('cgst', sumCGST, taxableValue);
        if (sumSGST > 0) updateTaxRow('sgst', sumSGST, taxableValue);
        if (sumIGST > 0) updateTaxRow('igst', sumIGST, taxableValue);

        // Update Tax Rows State ONLY if changed significantly check logic
        // Calculate total of "Auto Generated" rows to see if they changed
        const currentAutoTotal = taxCalculationRows.filter(r => r.isAutoGenerated).reduce((sum, r) => sum + r.amount, 0);
        const newAutoTotal = newTaxRows.filter(r => r.isAutoGenerated).reduce((sum, r) => sum + r.amount, 0);

        // Also check if any new manual rows were added (length diff)
        // OR if AutoGenerated Total changed
        if (newTaxRows.length !== taxCalculationRows.length || Math.abs(currentAutoTotal - newAutoTotal) > 0.01) {
            setTaxCalculationRows(newTaxRows);
        }

        // 3. Calculate TCS
        let tcsAmount = 0;
        if (formData.tcsPercent > 0) {
            // TCS is usually on (Basic + Tax + Other Charges)
            // Basic + Tax (already includes freight tax) + Other Charges
            // So Net Amount essentially
            const grossAmt = basicAmount + totalTax + otherCharges;
            tcsAmount = (grossAmt * formData.tcsPercent) / 100;
        }

        // 4. Calculate Net Amount
        // Basic + Tax (includes freight tax) + Other Charges + TCS + RoundOff
        let netAmount = basicAmount + totalTax + otherCharges + tcsAmount + (formData.roundOffAc || 0);

        setFormData(prev => ({
            ...prev,
            basicAmount: parseFloat(basicAmount.toFixed(2)),
            totalTax: parseFloat(totalTax.toFixed(2)),
            tcsAmount: parseFloat(tcsAmount.toFixed(2)),
            netAmount: parseFloat(netAmount.toFixed(2)),
            totalDispatchedQty: parseFloat(totalQty.toFixed(2)),
            netWeight: parseFloat(totalNetWeight.toFixed(2)),
            grossWeight: parseFloat(totalGrossWeight.toFixed(2))
        }));
    };

    // Re-write of handleItemChange to be clean and atomic
    const handleItemChange = async (itemId: number, field: string, value: any) => {

        let newItemData: any = {};
        const currentItem = invoiceItems.find(i => i.id === itemId);
        if (!currentItem) return;

        if (field === 'itemId') {
            // Broad search for selected item
            const selectedItem = itemsList.find(i => (i.id || i.ItemID || i.itemId || '').toString() === value);
            if (!selectedItem) return;

            // Use locally available stock data from the list (Requirement #2)
            const currentStock = selectedItem.netStock || selectedItem.PhysicalStock || 0;

            // Fetch batch details (Stock is already here, just need batch)
            let batchDetails: any = { TransactionID: 0, BatchNo: '', SupplierBatchNo: '', BatchName: '' };

            console.log(`ðŸ“¦ Item Change Selected:`, selectedItem);

            try {
                const { scrapApi } = await import('@/lib/api');
                const batchRes = await scrapApi.getItemBatchDetails(selectedItem.id || selectedItem.ItemID || selectedItem.itemId);
                if (batchRes.success && batchRes.data) {
                    batchDetails = batchRes.data;
                }
            } catch (err) {
                console.error("Failed to fetch item details", err);
            }

            // HSN Mapping
            let hsnGroup = null;
            if (selectedItem.ProductHSNID) {
                hsnGroup = hsnGroups.find(g => g.productHSNID === selectedItem.ProductHSNID);
            }
            if (!hsnGroup && selectedItem.HSNCode) {
                hsnGroup = hsnGroups.find(g => g.hsnCode === selectedItem.HSNCode);
            }

            const cgstRate = hsnGroup?.cgstTaxPercentage || selectedItem.cgstTaxPercentage || 0;
            const sgstRate = hsnGroup?.sgstTaxPercentage || selectedItem.sgstTaxPercentage || 0;
            const igstRate = hsnGroup?.igstTaxPercentage || selectedItem.igstTaxPercentage || 0;

            const unit = selectedItem.StockUnit || selectedItem.unit || 'KG';

            newItemData = {
                itemId: selectedItem.id || selectedItem.ItemID || selectedItem.itemId,
                itemCode: selectedItem.ItemCode || selectedItem.itemCode,
                itemName: selectedItem.ItemName || selectedItem.itemName,
                description: selectedItem.Description || '',
                productHSNName: hsnGroup?.productHSNName || selectedItem.productHSNName || '',
                hsnCode: hsnGroup?.hsnCode || selectedItem.HSNCode || '',

                // Auto-fill Quantity with FULL Stock (Requirement #2)
                quantity: currentStock,
                stockQty: currentStock, // Set stock limit

                // Store Dimensions for Conversion
                sizeL: selectedItem.SizeL || selectedItem.sizeL || 0,
                sizeW: selectedItem.SizeW || selectedItem.sizeW || 0,
                gsm: selectedItem.GSM || selectedItem.gsm || 0,
                originalStockUnit: selectedItem.StockUnit || selectedItem.unit || 'KG',

                // Sync Weight if KG (Requirement #3)
                netWeight: (unit === 'KG') ? currentStock : 0,
                grossWeight: (unit === 'KG') ? currentStock : 0,

                unit: unit,

                taxRate: cgstRate + sgstRate,
                gstTaxPercentage: cgstRate + sgstRate,
                cgstTaxPercentage: cgstRate,
                sgstTaxPercentage: sgstRate,
                igstTaxPercentage: igstRate,

                batchName: batchDetails.BatchName || batchDetails.BatchNo || '',
                batchNo: batchDetails.BatchNo || '',
                supplierBatchNo: batchDetails.SupplierBatchNo || '',
                transactionID: batchDetails.TransactionID ? batchDetails.TransactionID.toString() : ''
            };

            console.log(`ðŸ“¦ Item Changed: ${newItemData.itemName}, Fetched Stock: ${currentStock}, Auto-filled Quantity`);

        } else if (field === 'quantity') {
            // Validate quantity against stock (only if stock data is available)
            const newQuantity = Number(value);
            const stockQty = currentItem.stockQty || 0;

            // Only validate if we have actual stock data (stockQty > 0)
            if (stockQty > 0 && newQuantity > stockQty) {
                alert(`Quantity cannot exceed available stock (${stockQty} ${currentItem.unit})`);
                return; // Don't update if validation fails
            }

            newItemData = { [field]: newQuantity };

            // Auto-update weight if Unit is KG (Requirement #3)
            if (currentItem.unit === 'KG') {
                newItemData.netWeight = newQuantity;
                newItemData.grossWeight = newQuantity;
            }

        } else if (field === 'unit') {
            // Handle unit conversion between PCS and KG for items that have wtPerPacking
            const newUnit = value;
            const oldUnit = currentItem.unit;
            const wtPerPacking = currentItem.wtPerPacking || 0;
            const originalStockUnit = currentItem.originalStockUnit;

            newItemData = { [field]: newUnit };

            // Only convert if originalStockUnit is PCS and wtPerPacking exists
            if (originalStockUnit?.toUpperCase() === 'PCS' && wtPerPacking > 0) {
                // Converting from KG to PCS
                if (oldUnit === 'KG' && newUnit === 'PCS') {
                    const kgQty = currentItem.quantity || 0;
                    const pcsQty = kgQty / wtPerPacking;
                    newItemData.quantity = parseFloat(pcsQty.toFixed(3));
                }
                // Converting from PCS to KG
                else if (oldUnit === 'PCS' && newUnit === 'KG') {
                    const pcsQty = currentItem.quantity || 0;
                    const kgQty = pcsQty * wtPerPacking;
                    newItemData.quantity = parseFloat(kgQty.toFixed(3));
                    // Update weights
                    newItemData.netWeight = kgQty;
                    newItemData.grossWeight = kgQty;
                }
            }
            // Handle conversion between SHEET and KG
            else if ((originalStockUnit?.toUpperCase() === 'SHEET' || originalStockUnit?.toUpperCase() === 'SHEETS')) {
                const L = currentItem.sizeL || 0;
                const W = currentItem.sizeW || 0;
                const GSM = currentItem.gsm || 0;

                // Converting from KG to SHEET
                if (oldUnit === 'KG' && newUnit === 'SHEET' && L > 0 && W > 0 && GSM > 0) {
                    const kgQty = currentItem.quantity || 0;
                    // Formula: KG * 10^9 / (L * W * GSM)
                    const sheetQty = (kgQty * 1000000000) / (L * W * GSM);
                    newItemData.quantity = Math.round(sheetQty);
                }
                // Converting from SHEET to KG
                else if ((oldUnit === 'SHEET' || oldUnit === 'SHEETS') && newUnit === 'KG' && L > 0 && W > 0 && GSM > 0) {
                    const sheetQty = currentItem.quantity || 0;
                    // Formula: (L * W * GSM * Sheets) / 10^9
                    const kgQty = (L * W * GSM * sheetQty) / 1000000000;
                    newItemData.quantity = parseFloat(kgQty.toFixed(3));
                    newItemData.netWeight = newItemData.quantity;
                    newItemData.grossWeight = newItemData.quantity;
                }
            }

        } else {
            newItemData = { [field]: value };
        }

        // Apply updates and Recalculate GST
        setInvoiceItems(prev => prev.map(item => {
            if (item.id === itemId) {
                let updatedItem = { ...item, ...newItemData };

                // Recalculate Basic Amount (Quantity * Rate)
                if (field === 'quantity' || field === 'rate' || field === 'itemId') {
                    updatedItem.basicAmount = (updatedItem.quantity || 0) * (updatedItem.rate || 0);
                }

                // Apply Discount on Base Amount (BEFORE tax)
                if (field === 'discountPercent' || field === 'quantity' || field === 'rate' || field === 'itemId') {
                    const discountPercent = updatedItem.discountPercent || 0;
                    updatedItem.discountAmount = (updatedItem.basicAmount * discountPercent) / 100;
                    // Taxable amount is base amount minus discount
                    updatedItem.taxableAmount = updatedItem.basicAmount - updatedItem.discountAmount;
                }

                // Recalculate Tax on Taxable Amount (after discount)
                const isGstEnabled = companyGSTApplicable && clientGSTApplicable && voucherGSTApplicable;
                const taxableAmt = updatedItem.taxableAmount || updatedItem.basicAmount || 0;

                if (taxableAmt > 0) {
                    let newCgstAmt = 0, newSgstAmt = 0, newIgstAmt = 0;
                    if (isGstEnabled) {
                        if (isInterState) {
                            const rate = updatedItem.igstTaxPercentage > 0 ? updatedItem.igstTaxPercentage : 18;
                            newIgstAmt = (taxableAmt * rate) / 100;
                        } else {
                            newCgstAmt = (taxableAmt * updatedItem.cgstTaxPercentage) / 100;
                            newSgstAmt = (taxableAmt * updatedItem.sgstTaxPercentage) / 100;
                        }
                    }
                    updatedItem.cgstAmt = parseFloat(newCgstAmt.toFixed(2));
                    updatedItem.sgstAmt = parseFloat(newSgstAmt.toFixed(2));
                    updatedItem.igstAmt = parseFloat(newIgstAmt.toFixed(2));
                    updatedItem.taxAmount = parseFloat((newCgstAmt + newSgstAmt + newIgstAmt).toFixed(2));
                    // Total amount = Taxable Amount + Tax
                    updatedItem.amount = taxableAmt + updatedItem.taxAmount;
                }

                return updatedItem;
            }
            return item;
        }));

        // Post-update warning (safer place)
        if (field === 'quantity') {
            // Removed warning as per user request to avoid incorrect alerts
        }
    };

    const addNewItem = () => {
        const newItem: InvoiceItem = {
            id: invoiceItems.length + 1,
            itemId: 0,
            productMasterCode: '',
            productCode: '',
            itemName: '',
            itemCode: '',
            jobName: '',
            narration: '',
            description: '',
            isService: 'No',
            productHSNID: 0,
            productHSNName: '',
            hsnCode: '',
            freeQuantity: 0,
            quantity: 0,
            rate: 0,
            unit: 'KG',
            discountPercent: 0,
            discountAmount: 0,
            basicAmount: 0,
            taxRate: 0,
            gstTaxPercentage: 0,
            cgstTaxPercentage: 0,
            sgstTaxPercentage: 0,
            igstTaxPercentage: 0,
            taxAmount: 0,
            cgstAmt: 0,
            sgstAmt: 0,
            igstAmt: 0,
            taxableAmount: 0,
            amount: 0,
            packingReference: '',
            noOfPallet: 0,
            issueOuterCarton: 0,
            innerCarton: 0,
            netWeight: 0,
            grossWeight: 0,
            poNo: '',
            poDate: '',
            salesOrderNo: '',
            jobBookingNo: '',
            deliveryNoteNo: '',
            deliveryNoteDate: '',
            batchName: '',
            batchNo: '',
            supplierBatchNo: '',
            transactionID: ''
        };
        setInvoiceItems(prev => [...prev, newItem]);
    };

    const removeItem = (itemId: number) => {
        setInvoiceItems(prev => prev.filter(item => item.id !== itemId));
    };

    // Calculate totals
    useEffect(() => {
        const basicAmount = invoiceItems.reduce((sum, item) => sum + (item.basicAmount || 0), 0);

        // Calculate total tax from tax ledger table (not from items)
        const totalTaxFromLedgers = taxCalculationRows.reduce((sum, row) => sum + (row.amount || 0), 0);

        const tcsAmount = (basicAmount + totalTaxFromLedgers) * formData.tcsPercent / 100;
        const subtotal = basicAmount + totalTaxFromLedgers + tcsAmount;
        const roundOffAc = Math.round(subtotal) - subtotal;
        const netAmount = Math.round(subtotal);
        const totalDispatchedQty = invoiceItems.reduce((sum, item) => sum + (item.quantity || 0), 0);

        setFormData(prev => ({
            ...prev,
            basicAmount,
            totalTax: totalTaxFromLedgers,
            tcsAmount,
            roundOffAc,
            netAmount,
            totalDispatchedQty,
            netWeight: totalDispatchedQty,
            grossWeight: totalDispatchedQty * 1.02 // Assuming 2% packaging weight
        }));
    }, [invoiceItems, taxCalculationRows, formData.tcsPercent]);

    // Auto-calculate tax breakdown based on items and state
    useEffect(() => {
        if (invoiceItems.length === 0 || !formData.state || taxLedgers.length === 0) {
            // If no items, remove all auto-generated rows
            setTaxCalculationRows(prev => prev.filter(r => !r.isAutoGenerated));
            return;
        }

        // Group items by tax rate
        const taxGroups = invoiceItems.reduce((groups, item) => {
            // Calculate total GST rate from item (CGST + SGST or IGST)
            const totalGSTRate = item.cgstTaxPercentage + item.sgstTaxPercentage + item.igstTaxPercentage;

            if (totalGSTRate > 0 && item.basicAmount > 0) {
                const key = totalGSTRate.toString();
                if (!groups[key]) {
                    groups[key] = { taxRate: totalGSTRate, taxableAmount: 0 };
                }
                groups[key].taxableAmount += item.basicAmount;
            }
            return groups;
        }, {} as Record<string, { taxRate: number; taxableAmount: number }>);

        setTaxCalculationRows(prevRows => {
            const nextRows = prevRows.filter(r => !r.isAutoGenerated); // Start with manual rows only
            const activeAutoLedgerIds: string[] = [];

            Object.values(taxGroups).forEach(group => {
                let ledgersToUpdate: any[] = [];

                if (isInterState) {
                    // Interstate: Use IGST
                    const igstLedger = taxLedgers.find(l =>
                        l.LedgerName.toLowerCase().includes('igst') &&
                        (l.LedgerName.includes(group.taxRate.toString()) || l.TaxPercentage === group.taxRate)
                    );
                    if (igstLedger) ledgersToUpdate.push({ ledger: igstLedger, rate: group.taxRate });
                } else {
                    // Intrastate: Use CGST + SGST (split the rate in half)
                    const halfRate = group.taxRate / 2;

                    const cgstLedger = taxLedgers.find(l =>
                        l.LedgerName.toLowerCase().includes('cgst') &&
                        (l.LedgerName.includes(halfRate.toString()) || l.TaxPercentage === halfRate)
                    );
                    const sgstLedger = taxLedgers.find(l =>
                        l.LedgerName.toLowerCase().includes('sgst') &&
                        (l.LedgerName.includes(halfRate.toString()) || l.TaxPercentage === halfRate)
                    );

                    if (cgstLedger) ledgersToUpdate.push({ ledger: cgstLedger, rate: halfRate });
                    if (sgstLedger) ledgersToUpdate.push({ ledger: sgstLedger, rate: halfRate });
                }

                // Process ledgers
                ledgersToUpdate.forEach(({ ledger, rate }) => {
                    const ledgerIdStr = ledger.LedgerID.toString();
                    activeAutoLedgerIds.push(ledgerIdStr);

                    const existingRowIndex = nextRows.findIndex(r => r.isAutoGenerated && r.ledgerId === ledgerIdStr);

                    if (existingRowIndex >= 0) {
                        // Update existing row
                        const row = nextRows[existingRowIndex];
                        row.inAmount = group.taxableAmount;

                        if (!row.isManualAmount) {
                            row.taxRate = rate;
                            row.amount = (row.inAmount * rate) / 100;
                        }
                    } else {
                        // Add new row
                        nextRows.push({
                            id: Date.now() + Math.random(),
                            ledgerId: ledgerIdStr,
                            ledgerName: ledger.LedgerName,
                            taxRate: rate,
                            calculationOn: 'Value',
                            gstApplicable: true,
                            inAmount: group.taxableAmount,
                            amount: (group.taxableAmount * rate) / 100,
                            isManualAmount: false,
                            isAutoGenerated: true
                        });
                    }
                });
            });

            // Remove auto-generated rows that are no longer relevant (e.g., item removed or tax rate changed)
            return nextRows.filter(r => !r.isAutoGenerated || activeAutoLedgerIds.includes(r.ledgerId));
        });

    }, [invoiceItems, isInterState, taxLedgers]);

    // Recalculate item GST when tax settings change
    useEffect(() => {
        // Debounce processing to avoid too many API calls if multiple flags change at once?
        // Since these flags usually change one by one (or via handleClientChange), we should be careful.
        // However, for now direct reaction is acceptable.
        if (invoiceItems.length > 0) {
            invoiceItems.forEach(item => {
                if (item.productHSNName && item.basicAmount > 0) {
                    // Trigger API calculation.
                    // Note: calculateItemGST handles its own state updates.
                    // We should probably check if the item ACTUALLY needs update (e.g. if tax is already correct),
                    // but checking that against the API prediction is hard without calling the API.
                    calculateItemGST(item, item.basicAmount);
                }
            });
        }
    }, [clientGSTApplicable, companyGSTApplicable, voucherGSTApplicable, clientStateTinNo, companyStateTinNo]);

    const addTaxLedger = () => {
        if (!selectedTaxLedger) return;

        const ledger = taxLedgers.find(l => l.LedgerID.toString() === selectedTaxLedger);
        if (!ledger) return;

        // Use TaxPercentage from ledger data
        const taxRate = ledger.TaxPercentage || 0;
        const calculationOn = (ledger.GSTCalculationOn || 'Value') as 'Value' | 'Quantity';
        const gstApplicable = ledger.GSTApplicable === 'True' || ledger.GSTApplicable === true;

        // Calculate based on calculation type
        let inAmount = 0;
        let calculatedAmount = 0;

        if (calculationOn === 'Value') {
            inAmount = formData.basicAmount || 0;
            calculatedAmount = (inAmount * taxRate) / 100;
        } else if (calculationOn === 'Quantity') {
            inAmount = formData.totalDispatchedQty || 0;
            calculatedAmount = (inAmount * taxRate) / 100;
        }

        const newRow: TaxCalculationRow = {
            id: Date.now(),
            ledgerId: ledger.LedgerID.toString(),
            ledgerName: ledger.LedgerName,
            taxRate: taxRate,
            calculationOn: calculationOn,
            gstApplicable: gstApplicable,
            inAmount: inAmount,
            amount: calculatedAmount,
            isManualAmount: false,
            isAutoGenerated: false
        };

        setTaxCalculationRows([...taxCalculationRows, newRow]);
        setSelectedTaxLedger('');
    };

    const handleSave = async (e: React.FormEvent) => {
        e.preventDefault();

        try {
            const { scrapApi } = await import('@/lib/api');
            if (!formData.clientId) {
                setValidationError('Please select Client first');
                return;
            }
            if (!formData.voucherType) {
                setValidationError('Please select Voucher Type first');
                return;
            }

            // Check for HSN Group Name in all items
            const itemMissingHSN = invoiceItems.find(item => !item.productHSNName);
            if (itemMissingHSN) {
                setValidationError(`Please select HSN Group Name for item "${itemMissingHSN.itemName}" first`);
                return;
            }

            if (invoiceItems.length === 0) {
                setValidationError('Please add at least one item');
                return;
            }

            setSaving(true);

            // Construct InvoiceTransactionMain (matches OperationInvoicemain)
            const mainData = {
                VoucherID: formData.voucherId,
                VoucherPrefix: formData.prefix,
                VoucherDate: formData.invoiceDate,
                LedgerID: parseInt(formData.clientId),
                InvoiceType: formData.invoiceType,
                ConsigneeLedgerID: formData.consigneeId ? parseInt(formData.consigneeId) : 0,
                TotalQuantity: invoiceItems.reduce((sum, item) => sum + (item.quantity || 0), 0),
                TotalBasicAmount: formData.basicAmount,
                TotalDiscountAmount: 0, // Calculated if needed
                TotalCGSTTaxAmount: invoiceItems.reduce((sum, item) => sum + (item.cgstAmt || 0), 0) + taxCalculationRows.filter(r => r.ledgerName.toUpperCase().includes('CGST')).reduce((sum, row) => sum + row.amount, 0),
                TotalSGSTTaxAmount: invoiceItems.reduce((sum, item) => sum + (item.sgstAmt || 0), 0) + taxCalculationRows.filter(r => r.ledgerName.toUpperCase().includes('SGST')).reduce((sum, row) => sum + row.amount, 0),
                TotalIGSTTaxAmount: invoiceItems.reduce((sum, item) => sum + (item.igstAmt || 0), 0) + taxCalculationRows.filter(r => r.ledgerName.toUpperCase().includes('IGST')).reduce((sum, row) => sum + row.amount, 0),
                TotalTaxAmount: formData.totalTax,
                NetAmount: formData.netAmount,
                Narration: formData.remark,
                SalesLedgerID: formData.salesLedgerId ? parseInt(formData.salesLedgerId) : 0,
                IsDirectInvoice: true, // Default based on context
                IsItemSalesInvoice: true, // Default based on context
                RoundOffTax: formData.roundOffAc || 0,

                // New Fields
                DocumentType: formData.documentType,
                IsExport: formData.isExport === 'yes',
                CurrencyCode: formData.currency,
                ShippedFrom: formData.shippedFrom,
                ShippedLedgerType: "", // Not in state
                ShippedLedgerID: 0, // Not in state
                IGSTOnIntra: formData.igstOnIntra === 'yes',
                ReverseCharge: formData.reverseCharge === 'yes',
                ECommerce: formData.eCommerce === 'yes',
                ECommerceLedgerID: 0, // Not in state
                Destination: formData.destination,
                OriginCountry: formData.country,
                DestinationCountry: "", // Not in state
                NotifyParty1: 0, // Not in state
                NotifyParty2: 0, // Not in state
                LoadingPort: "", // Not in state
                DischargePort: "", // Not in state
                BankerID: 0, // Not in state
                EWayBillDate: formData.eWayBillDate || null,
                TransporterID: formData.transporterId ? parseInt(formData.transporterId) : 0,
                VehicleNo: formData.vehicleNo,
                PODNo: formData.podNo || "",
                Freight: formData.freight || "",
                TotalDistance: formData.distance || "",
                CurrConversionValue: formData.conversionRate || 1,
                EPCGLicenceNo: "",
                REXRegistrationNo: "",
                DeliveryTerms: "",
                PaymentTerms: formData.paymentTerms || "",
                NetWeight: formData.netWeight || 0,
                GrossWeight: formData.grossWeight || 0,
                OtherRemarks: "",
                InvoiceReferenceNo: formData.invoiceRefNo || "",
                ContainerDescription: "",
                DBKRemarks: "",
                EWayBillNumber: formData.eWayBill || "",
                FYear: (() => {
                    const now = new Date();
                    const currentYear = now.getFullYear();
                    const currentMonth = now.getMonth(); // 0-11 (0 = January)

                    // Financial year in India: April 1st to March 31st
                    // If month is April (3) to December (11), FY is current year to next year
                    // If month is January (0) to March (2), FY is previous year to current year
                    if (currentMonth >= 3) {
                        // April to December: FY is current-next year
                        return `${currentYear}-${currentYear + 1}`;
                    } else {
                        // January to March: FY is previous-current year
                        return `${currentYear - 1}-${currentYear}`;
                    }
                })(),
                // Pass ProductionUnitID from selected production unit (priority) or fallback to user's default
                ProductionUnitID: parseInt(sessionStorage.getItem('selectedProductionUnitId') || localStorage.getItem('scrap_production_unit_id') || '0'),
                // Pass UserID from storage
                UserID: parseInt(localStorage.getItem('scrap_user_id') || '0')
            };

            // Construct InvoiceTransactionDetail (matches OperationInvoiceDetyail)
            const items = invoiceItems.map((item, index) => ({
                FGTransactionID: 0,
                JobBookingID: 0,
                JobBookingJobCardContentsID: 0,
                ProductMasterID: 0, // Need to map from item selection
                BookingID: 0,
                OrderBookingID: 0,
                OrderBookingDetailsID: 0,
                JobName: item.jobName || "",
                Quantity: item.quantity,
                RateType: item.unit,
                Rate: item.rate,
                GrossAmount: item.basicAmount,
                DiscountPercentage: item.discountPercent,
                DiscountAmount: item.discountAmount,
                BasicAmount: item.basicAmount,
                TaxableAmount: item.taxableAmount,
                GSTPercentage: item.gstTaxPercentage,
                CGSTPercentage: item.cgstTaxPercentage,
                SGSTPercentage: item.sgstTaxPercentage,
                IGSTPercentage: item.igstTaxPercentage,
                CGSTAmount: item.cgstAmt,
                SGSTAmount: item.sgstAmt,
                IGSTAmount: item.igstAmt,
                NetAmount: item.amount,
                ProductNarration: item.narration || "",
                ProductHSNID: item.productHSNID || 0,
                ProductCode: item.itemCode,
                IsService: item.isService,
                PackingReference: item.packingReference || "",
                NoOfPallet: item.noOfPallet || 0,
                PONo: item.poNo,
                PODate: item.poDate || null,
                IssueOuterCarton: item.issueOuterCarton || 0,
                InnerCarton: item.innerCarton || 0,
                NetWeight: item.netWeight || 0,
                GrossWeight: item.grossWeight || 0,
                ItemSOTransactionID: 0,
                ItemID: item.itemId // Important
            }));

            // Construct InvoiceTransactionTaxes (matches OperationRecordTax)
            const taxes = taxCalculationRows.map(row => {
                const isCGST = row.ledgerName.toUpperCase().includes('CGST');
                const isSGST = row.ledgerName.toUpperCase().includes('SGST');
                const isIGST = row.ledgerName.toUpperCase().includes('IGST');

                return {
                    LedgerID: parseInt(row.ledgerId),
                    TaxPercentage: row.taxRate,
                    Amount: row.amount,
                    TaxInAmount: row.inAmount,
                    IsComulative: false,
                    GSTApplicable: row.gstApplicable,
                    IsService: false,
                    CalculatedON: row.calculationOn,
                    ProductHSNID: 0,
                    GSTPercentage: isIGST ? row.taxRate : (isCGST || isSGST ? row.taxRate * 2 : 0), // Estimate GST %
                    CGSTPercentage: isCGST ? row.taxRate : 0,
                    SGSTPercentage: isSGST ? row.taxRate : 0,
                    IGSTPercentage: isIGST ? row.taxRate : 0,
                    CGSTAmount: isCGST ? row.amount : 0,
                    SGSTAmount: isSGST ? row.amount : 0,
                    IGSTAmount: isIGST ? row.amount : 0,
                    TotalAmount: row.amount
                };
            });

            const payload = {
                MainData: mainData,
                Items: items,
                Taxes: taxes
            };

            console.log("Saving Invoice Payload:", payload);

            let result;
            if (isEditMode && editingInvoiceId) {
                // Update existing invoice
                result = await scrapApi.updateInvoice(editingInvoiceId, payload);
                setSaveSuccess(`Invoice updated successfully! Trx ID: ${(result as any).transactionId}`);
            } else {
                // Create new invoice
                result = await scrapApi.createSale(payload);
                setSaveSuccess(`Invoice saved successfully! Trx ID: ${(result as any).transactionId}`);
            }

            // Navigate to processed invoices page after successful save/update
            setTimeout(() => {
                router.push('/scrap/processed');
            }, 1500);

        } catch (error: any) {
            console.error('Error saving invoice:', error);
            // alert('Failed to save invoice. See console for details.'); 
            // Ideally show error state too, but user asked for saved message improvement specifically.
        } finally {
            setSaving(false);
        }
    };

    const handlePrint = () => {
        const client = clients.find(c => c.LedgerID.toString() === formData.clientId);
        const consignee = consignees.find(c => c.LedgerID.toString() === formData.consigneeId);

        // Helper to extract address safely
        const getAddress = (party: any) => {
            if (!party) return '';
            return [party.Address1, party.Address2, party.City, party.State, party.Pincode].filter(Boolean).join(', ');
        };

        // Recalculate totals for print to ensure accuracy
        // FIX: Sum up explicit tax components instead of item.taxAmount which might be missing/outdated
        const printTotalTax = invoiceItems.reduce((sum, item) =>
            sum + (item.cgstAmt || 0) + (item.sgstAmt || 0) + (item.igstAmt || 0), 0);

        const printTotalDiscount = invoiceItems.reduce((sum, item) => sum + (item.discountAmount || 0), 0);
        const hasDiscount = printTotalDiscount > 0;
        const printBasicAmount = invoiceItems.reduce((sum, item) => sum + (item.basicAmount || 0), 0);
        const printOtherCharges = taxCalculationRows.filter(r => !r.isAutoGenerated).reduce((sum, r) => sum + r.amount, 0);
        const printNetAmount = printBasicAmount + printTotalTax + (formData.tcsAmount || 0) + (formData.roundOffAc || 0) + printOtherCharges;

        // ... HTML generation ...
        const invoiceHTML = `
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Invoice ${formData.invoiceNo || 'Draft'}</title>
  <style>
    @page { size: A4; margin: 10mm; }
    body { font-family: 'Helvetica', Arial, sans-serif; font-size: 10px; line-height: 1.3; color: #333; }
    .container { width: 100%; max-width: 210mm; margin: 0 auto; }
    .header { text-align: center; margin-bottom: 20px; border-bottom: 2px solid #333; padding-bottom: 10px; }
    .header h1 { font-size: 24px; font-weight: bold; margin: 0; color: #000; text-transform: uppercase; }
    .header p { margin: 2px 0; font-size: 12px; }
    
    .invoice-info { display: flex; justify-content: space-between; margin-bottom: 20px; }
    .box { flex: 1; border: 1px solid #ccc; padding: 10px; margin-right: 10px; }
    .box:last-child { margin-right: 0; }
    .box h3 { font-size: 12px; border-bottom: 1px solid #eee; margin-bottom: 5px; padding-bottom: 2px; color: #000; }
    .row { display: flex; margin-bottom: 2px; }
    .label { font-weight: bold; width: 80px; color: #555; }
    .val { flex: 1; }

    table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
    th { background: #f0f0f0; border: 1px solid #ccc; padding: 5px; text-align: left; font-weight: bold; }
    td { border: 1px solid #ccc; padding: 5px; }
    .text-right { text-align: right; }
    .text-center { text-align: center; }
    .total-row td { font-weight: bold; background: #fafafa; }

    .footer { margin-top: 30px; display: flex; justify-content: space-between; }
    .terms { flex: 2; font-size: 9px; padding-right: 20px; }
    .sign { flex: 1; text-align: center; margin-top: 40px; border-top: 1px solid #000; padding-top: 5px; }

    @media print {
      body { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
      .container { padding: 0; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>Tax Invoice</h1>
      <p>Original for Recipient</p>
    </div>

    <div class="invoice-info">
      <div class="box">
        <h3>Details of Receiver (Billed To)</h3>
        <div class="row"><span class="label">Name:</span><span class="val">${client?.LedgerName || ''}</span></div>
        <div class="row"><span class="label">Address:</span><span class="val">${getAddress(client)}</span></div>
        <div class="row"><span class="label">GSTIN:</span><span class="val">${client?.GSTNo || ''}</span></div>
        <div class="row"><span class="label">State:</span><span class="val">${client?.State || ''}</span></div>
      </div>
      <div class="box">
        <h3>Details of Consignee (Shipped To)</h3>
        <div class="row"><span class="label">Name:</span><span class="val">${consignee?.LedgerName || client?.LedgerName || ''}</span></div>
        <div class="row"><span class="label">Address:</span><span class="val">${getAddress(consignee) || getAddress(client)}</span></div>
        <div class="row"><span class="label">State:</span><span class="val">${consignee?.State || client?.State || ''}</span></div>
        <div class="row"><span class="label">Place:</span><span class="val">${formData.destination || ''}</span></div>
      </div>
      <div class="box">
        <h3>Invoice Details</h3>
        <div class="row"><span class="label">Invoice No:</span><span class="val">${formData.invoiceNo || 'Draft'}</span></div>
        <div class="row"><span class="label">Date:</span><span class="val">${formData.invoiceDate}</span></div>
        <div class="row"><span class="label">E-Way Bill:</span><span class="val">${formData.eWayBill || '-'}</span></div>
        <div class="row"><span class="label">Vehicle No:</span><span class="val">${formData.vehicleNo || '-'}</span></div>
      </div>
    </div>

    <table>
      <thead>
        <tr>
          <th style="width: 30px">S.N.</th>
          <th>Description of Goods</th>
          <th style="width: 60px">HSN/SAC</th>
          <th style="width: 40px" class="text-right">Qty</th>
          <th style="width: 40px">Unit</th>
          <th style="width: 60px" class="text-right">Rate</th>
          <th style="width: 60px" class="text-right">Amount</th>
          ${hasDiscount ? '<th style="width: 40px" class="text-right">Disc</th>' : ''}
          <th style="width: 60px" class="text-right">Taxable</th>
          <th style="width: 40px" class="text-right">GST%</th>
          <th style="width: 60px" class="text-right">Tax Amt</th>
          <th style="width: 70px" class="text-right">Total</th>
        </tr>
      </thead>
      <tbody>
        ${invoiceItems.map((item, index) => `
        <tr>
          <td class="text-center">${index + 1}</td>
          <td>${item.itemName || 'Item'} <br/><span style="font-size:8px;color:#666">${item.description || ''}</span></td>
          <td>${item.hsnCode || ''}</td>
          <td class="text-right">${item.quantity}</td>
          <td>${item.unit}</td>
          <td class="text-right">${item.rate}</td>
          <td class="text-right">${item.basicAmount.toFixed(2)}</td>
          ${hasDiscount ? `<td class="text-right">${item.discountAmount.toFixed(2)}</td>` : ''}
          <td class="text-right">${item.taxableAmount.toFixed(2)}</td>
          <td class="text-right">${isInterState ? (item.igstTaxPercentage || 0) : ((item.cgstTaxPercentage || 0) + (item.sgstTaxPercentage || 0))}%</td>
          <td class="text-right">${((item.cgstAmt || 0) + (item.sgstAmt || 0) + (item.igstAmt || 0)).toFixed(2)}</td>
          <td class="text-right">${item.amount.toFixed(2)}</td>
        </tr>`).join('')}
        
        <tr class="total-row">
          <td colspan="6" class="text-right">Total:</td>
          <td class="text-right">${printBasicAmount.toFixed(2)}</td>
          <td class="text-right"></td>
          <td class="text-right">${invoiceItems.reduce((acc, i) => acc + i.taxableAmount, 0).toFixed(2)}</td>
          <td></td>
          <td class="text-right">${printTotalTax.toFixed(2)}</td>
          <td class="text-right">${(printBasicAmount + printTotalTax).toFixed(2)}</td>
        </tr>
      </tbody>
    </table>

    <div class="row" style="align-items: flex-start;">
        <div style="flex: 1;">
            <p><strong>Amount in Words:</strong> (Auto-generated disabled for preview)</p>
            <br/>
            <h4>Tax Details:</h4>
            <table style="width: 60%;">
                <thead>
                    <tr><th>Tax Ledger</th><th>Taxable</th><th>Tax Rate</th><th>Tax Amount</th></tr>
                </thead>
                <tbody>
                    ${taxCalculationRows.map(row => `
                    <tr>
                        <td>${row.ledgerName}</td>
                        <td class="text-right">${row.inAmount.toFixed(2)}</td>
                        <td class="text-right">${row.taxRate}%</td>
                        <td class="text-right">${row.amount.toFixed(2)}</td>
                    </tr>
                    `).join('')}
                </tbody>
            </table>
        </div>
        <div style="width: 300px; padding-left: 20px;">
           <div class="row"><span class="label" style="width:120px">Total Basic:</span><span class="val text-right">${printBasicAmount.toFixed(2)}</span></div>
           ${hasDiscount ? `<div class="row"><span class="label" style="width:120px">Discount:</span><span class="val text-right">(-)${printTotalDiscount.toFixed(2)}</span></div>` : ''}
           <div class="row"><span class="label" style="width:120px">Total Taxable:</span><span class="val text-right">${invoiceItems.reduce((acc, i) => acc + i.taxableAmount, 0).toFixed(2)}</span></div>
           <div class="row"><span class="label" style="width:120px">Total Tax:</span><span class="val text-right">${printTotalTax.toFixed(2)}</span></div>
           ${printOtherCharges > 0 ? `<div class="row"><span class="label" style="width:120px">Freight / Other:</span><span class="val text-right">${printOtherCharges.toFixed(2)}</span></div>` : ''}
           <div class="row"><span class="label" style="width:120px">Round Off:</span><span class="val text-right">${formData.roundOffAc?.toFixed(2) || '0.00'}</span></div>
           <div class="row" style="font-size: 14px; font-weight: bold; border-top: 1px solid #000; margin-top: 5px; padding-top: 5px;"><span class="label" style="width:120px">Grand Total:</span><span class="val text-right">â‚¹ ${printNetAmount.toFixed(2)}</span></div>
        </div>
    </div>

    <div class="footer">
      <div class="terms">
        <strong>Terms & Conditions:</strong>
        <ol>
          <li>Goods once sold will not be taken back.</li>
          <li>Interest @ 18% p.a. will be charged if payment is not made within due date.</li>
          <li>Subject to local jurisdiction.</li>
        </ol>
      </div>
      <div class="sign">
        <strong>Authorized Signatory</strong>
        <br/><br/><br/>
        (Signature & Seal)
      </div>
    </div>
  </div>
</body>
</html>
    `;

        const printWindow = window.open('', '_blank', 'width=800,height=600');
        if (printWindow) {
            printWindow.document.write(invoiceHTML);
            printWindow.document.close();
            printWindow.focus();
            setTimeout(() => {
                printWindow.print();
            }, 500);
        }
    };
    if (loading) {
        return (
            <Layout activePage="sales" headerAction={null}>
                <div className="p-6 space-y-6 bg-slate-50 dark:bg-slate-950 h-full">
                    <Skeleton className="h-12 w-64 bg-slate-200 dark:bg-slate-800" />
                    <Skeleton className="h-96 w-full bg-slate-200 dark:bg-slate-800" />
                </div>
            </Layout>
        );
    }

    const headerAction = (
        <div className="flex items-center gap-1">
            <button
                type="button"
                onClick={handlePrint}
                className="flex items-center gap-0.5 px-2 py-1 bg-white dark:bg-slate-900 border border-slate-300 dark:border-slate-700 rounded hover:bg-slate-50 dark:hover:bg-slate-800 text-slate-700 dark:text-slate-300 text-[11px] font-medium transition-colors"
            >
                <Printer size={12} />
                <span>Print</span>
            </button>
            <button
                type="button"
                disabled={saving}
                onClick={handleSave}
                className="flex items-center gap-0.5 px-2 py-1 bg-blue-600 text-white rounded hover:bg-blue-700 disabled:opacity-50 text-[11px] font-medium transition-colors"
            >
                <Save size={12} />
                <span>{saving ? (isEditMode ? 'Updating...' : 'Saving...') : (isEditMode ? 'Update' : 'Save')}</span>
            </button>
        </div>
    );

    return (
        <Layout activePage="sales" headerAction={headerAction}>
            <div className="h-full w-full bg-slate-50 dark:bg-slate-950 overflow-hidden">
                <div className="h-full overflow-y-auto overflow-x-auto px-1.5 py-2 pb-16 lg:pb-6">

                    {/* Success Message */}
                    {saveSuccess && (
                        <div className="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded relative mb-4" role="alert">
                            <strong className="font-bold">Success! </strong>
                            <span className="block sm:inline">{saveSuccess}</span>
                        </div>
                    )}

                    {/* Invoice Form */}
                    <div className="bg-white dark:bg-slate-900 rounded-lg border border-slate-300 dark:border-slate-800 shadow-md p-1.5">

                        {/* All Invoice Fields - Compact Layout */}
                        <div className="grid grid-cols-3 lg:grid-cols-6 gap-1.5 lg:pr-[10px]">

                            {/* Voucher Type */}
                            <div>
                                <label className="block text-xs font-medium text-slate-700 dark:text-slate-300 mb-0.5">Voucher Type</label>
                                <select
                                    className="w-full p-1.5 border border-slate-200 dark:border-slate-700 rounded focus:ring-1 focus:ring-blue-500 outline-none text-sm bg-white dark:bg-slate-900 text-slate-900 dark:text-slate-100"
                                    value={formData.voucherType}
                                    onChange={(e) => handleVoucherTypeChange(e.target.value)}
                                >
                                    <option value="">-- Select --</option>
                                    {voucherTypes.map((vt: any, idx: number) => (
                                        <option key={`${vt.voucherId}-${idx}`} value={vt.voucherName}>
                                            {vt.voucherName}
                                        </option>
                                    ))}
                                </select>
                            </div>

                            {/* Prefix (Auto-filled, Read-only) */}
                            <div>
                                <label className="block text-xs font-medium text-slate-700 dark:text-slate-300 mb-0.5">Prefix</label>
                                <input
                                    type="text"
                                    className="w-full p-1.5 border border-slate-200 dark:border-slate-700 rounded text-sm bg-slate-50 dark:bg-slate-800 text-slate-700 dark:text-slate-300"
                                    value={formData.prefix}
                                    readOnly
                                    placeholder="Auto"
                                />
                            </div>

                            {/* Document Type */}
                            <div>
                                <label className="block text-xs font-medium text-slate-700 dark:text-slate-300 mb-0.5">Doc Type</label>
                                <input
                                    type="text"
                                    className="w-full p-1.5 border border-slate-200 dark:border-slate-700 rounded bg-slate-50 dark:bg-slate-800 text-sm text-slate-700 dark:text-slate-300"
                                    value={formData.documentType}
                                    readOnly
                                />
                            </div>

                            {/* Invoice Type */}
                            <div>
                                <label className="block text-xs font-medium text-slate-700 dark:text-slate-300 mb-0.5">Inv Type</label>
                                <input
                                    type="text"
                                    className="w-full p-1.5 border border-slate-200 dark:border-slate-700 rounded bg-slate-50 dark:bg-slate-800 text-sm"
                                    value={formData.invoiceType}
                                    readOnly
                                />
                            </div>

                            {/* Export? */}
                            <div>
                                <label className="block text-xs font-medium text-slate-700 dark:text-slate-300 mb-0.5">Export?</label>
                                <select
                                    className="w-full p-1.5 border border-slate-200 dark:border-slate-700 rounded focus:ring-1 focus:ring-blue-500 outline-none text-sm"
                                    value={formData.isExport}
                                    onChange={(e) => setFormData({ ...formData, isExport: e.target.value })}
                                >
                                    <option value="No">No</option>
                                    <option value="Yes">Yes</option>
                                </select>
                            </div>



                            {/* Currency */}
                            <div>
                                <label className="block text-xs font-medium text-slate-700 dark:text-slate-300 mb-0.5">Currency</label>
                                <input
                                    type="text"
                                    className="w-full p-1.5 border border-slate-200 dark:border-slate-700 rounded bg-slate-50 dark:bg-slate-800 text-sm"
                                    value={formData.currency}
                                    readOnly
                                />
                            </div>

                            {/* Conv Rate */}
                            <div>
                                <label className="block text-xs font-medium text-slate-700 dark:text-slate-300 mb-0.5">Conv Rate</label>
                                <input
                                    type="text"
                                    className="w-full p-1.5 border border-slate-200 dark:border-slate-700 rounded bg-slate-50 dark:bg-slate-800 text-sm"
                                    value={formData.conversionRate}
                                    readOnly
                                />
                            </div>

                            {/* Invoice No */}
                            <div>
                                <label className="block text-xs font-medium text-slate-700 dark:text-slate-300 mb-0.5">Invoice No</label>
                                <input
                                    type="text"
                                    className="w-full p-1.5 border border-slate-200 dark:border-slate-700 rounded bg-slate-50 dark:bg-slate-800 text-sm font-mono"
                                    value={formData.invoiceNo || 'Auto-generated'}
                                    readOnly
                                />
                            </div>

                            {/* Date */}
                            <div>
                                <label className="block text-xs font-medium text-slate-700 dark:text-slate-300 mb-0.5">Date</label>
                                <input
                                    type="date"
                                    className="w-full p-1.5 border border-slate-200 dark:border-slate-700 rounded focus:ring-1 focus:ring-blue-500 outline-none text-sm"
                                    value={formData.invoiceDate}
                                    onChange={(e) => setFormData({ ...formData, invoiceDate: e.target.value })}
                                />
                            </div>

                            {/* Client Selection */}
                            <div>
                                <label className="block text-xs font-medium text-slate-700 dark:text-slate-300 mb-0.5">Client Name</label>
                                <SearchableSelect
                                    options={clients.map(c => ({ value: c.LedgerID.toString(), label: c.LedgerName }))}
                                    value={formData.clientId}
                                    onChange={handleClientChange}
                                    placeholder="Select Client"
                                    className="text-xs"
                                />
                            </div>

                            {/* Trade Name */}
                            <div>
                                <label className="block text-xs font-medium text-slate-700 dark:text-slate-300 mb-0.5">Trade Name</label>
                                <input
                                    type="text"
                                    className="w-full p-1.5 border border-slate-200 dark:border-slate-700 rounded bg-slate-50 dark:bg-slate-800 text-sm"
                                    value={formData.tradeName}
                                    title={formData.tradeName}
                                    readOnly
                                />
                            </div>

                            {/* Country */}
                            <div>
                                <label className="block text-xs font-medium text-slate-700 dark:text-slate-300 mb-0.5">Country</label>
                                <input
                                    type="text"
                                    className="w-full p-1.5 border border-slate-200 dark:border-slate-700 rounded bg-slate-50 dark:bg-slate-800 text-sm"
                                    value={formData.country}
                                    title={formData.country}
                                    readOnly
                                />
                            </div>

                            {/* State */}
                            <div>
                                <label className="block text-xs font-medium text-slate-700 dark:text-slate-300 mb-0.5">State</label>
                                <input
                                    type="text"
                                    className="w-full p-1.5 border border-slate-200 dark:border-slate-700 rounded bg-slate-50 dark:bg-slate-800 text-sm"
                                    value={formData.state}
                                    title={formData.state}
                                    readOnly
                                />
                            </div>

                            {/* Sales Ledger */}
                            <div>
                                <label className="block text-xs font-medium text-slate-700 dark:text-slate-300 mb-0.5">Sales Ledger</label>
                                <SearchableSelect
                                    options={salesLedgers.map(ledger => ({
                                        value: ledger.LedgerID,
                                        label: ledger.LedgerName
                                    }))}
                                    value={formData.salesLedgerId}
                                    onChange={(value) => setFormData({ ...formData, salesLedgerId: value })}
                                    placeholder="Select Sales Ledger"
                                    className="text-xs"
                                />
                            </div>

                            {/* Consignee Selection */}
                            <div>
                                <label className="block text-xs font-medium text-slate-700 dark:text-slate-300 mb-0.5">Consignee (Ship To)</label>
                                <SearchableSelect
                                    options={consignees.map(c => ({ value: c.LedgerID.toString(), label: c.LedgerName }))}
                                    value={formData.consigneeId}
                                    onChange={(val) => setFormData({ ...formData, consigneeId: val })}
                                    placeholder="Select Consignee"
                                    className="text-xs"
                                />
                            </div>

                            {/* Consignee Trade Name */}
                            <div>
                                <label className="block text-xs font-medium text-slate-700 dark:text-slate-300 mb-0.5">Consignee Trade</label>
                                <input
                                    type="text"
                                    className="w-full p-1.5 border border-slate-200 dark:border-slate-700 rounded bg-slate-50 dark:bg-slate-800 text-sm"
                                    value={formData.consigneeTradeName}
                                    title={formData.consigneeTradeName}
                                    readOnly
                                />
                            </div>

                            {/* Destination */}
                            <div>
                                <label className="block text-xs font-medium text-slate-700 dark:text-slate-300 mb-0.5">Destination</label>
                                <input
                                    type="text"
                                    className="w-full p-1.5 border border-slate-200 dark:border-slate-700 rounded focus:ring-1 focus:ring-blue-500 outline-none text-sm"
                                    value={formData.destination}
                                    title={formData.destination}
                                    onChange={(e) => setFormData({ ...formData, destination: e.target.value })}
                                    placeholder="Place of Supply"
                                />
                            </div>

                            {/* Shipped From */}
                            <div>
                                <label className="block text-xs font-medium text-slate-700 dark:text-slate-300 mb-0.5">Shipped From</label>
                                <input
                                    type="text"
                                    className="w-full p-1.5 border border-slate-200 dark:border-slate-700 rounded focus:ring-1 focus:ring-blue-500 outline-none text-sm"
                                    value={formData.shippedFrom}
                                    title={formData.shippedFrom}
                                    onChange={(e) => setFormData({ ...formData, shippedFrom: e.target.value })}
                                    placeholder="Location"
                                />
                            </div>

                            {/* IGST On Intra */}
                            <div>
                                <label className="block text-xs font-medium text-slate-700 dark:text-slate-300 mb-0.5">IGST Intra</label>
                                <select
                                    className="w-full p-1.5 border border-slate-200 dark:border-slate-700 rounded focus:ring-1 focus:ring-blue-500 outline-none text-sm"
                                    value={formData.igstOnIntra}
                                    onChange={(e) => setFormData({ ...formData, igstOnIntra: e.target.value })}
                                >
                                    <option value="no">No</option>
                                    <option value="yes">Yes</option>
                                </select>
                            </div>

                            {/* E-Commerce */}
                            <div>
                                <label className="block text-xs font-medium text-slate-700 dark:text-slate-300 mb-0.5">E-Commerce</label>
                                <select
                                    className="w-full p-1.5 border border-slate-200 dark:border-slate-700 rounded focus:ring-1 focus:ring-blue-500 outline-none text-sm"
                                    value={formData.eCommerce}
                                    onChange={(e) => setFormData({ ...formData, eCommerce: e.target.value })}
                                >
                                    <option value="no">No</option>
                                    <option value="yes">Yes</option>
                                </select>
                            </div>

                            {/* Freight */}
                            <div>
                                <label className="block text-xs font-medium text-slate-700 dark:text-slate-300 mb-0.5">Freight</label>
                                <select
                                    className="w-full p-1.5 border border-slate-200 dark:border-slate-700 rounded focus:ring-1 focus:ring-blue-500 outline-none text-sm"
                                    value={formData.freight}
                                    onChange={(e) => setFormData({ ...formData, freight: e.target.value })}
                                >
                                    <option value="Paid">Paid</option>
                                    <option value="ToPay">To Pay</option>
                                </select>
                            </div>

                            {/* Reverse Charge */}
                            <div>
                                <label className="block text-xs font-medium text-slate-700 dark:text-slate-300 mb-0.5">Reverse Charge</label>
                                <select
                                    className="w-full p-1.5 border border-slate-200 dark:border-slate-700 rounded focus:ring-1 focus:ring-blue-500 outline-none text-sm"
                                    value={formData.reverseCharge}
                                    onChange={(e) => setFormData({ ...formData, reverseCharge: e.target.value })}
                                >
                                    <option value="no">No</option>
                                    <option value="yes">Yes</option>
                                </select>
                            </div>

                        </div>

                        <div className="my-3 md:my-4 border-t border-slate-200 dark:border-slate-700"></div>

                        {/* Item List */}
                        <div>
                            <div className="flex justify-between items-center mb-3 md:mb-4">
                                <h3 className="text-sm md:text-lg font-semibold text-slate-800 dark:text-slate-100">Item List</h3>
                                <button
                                    onClick={addNewItem}
                                    className="flex items-center gap-1 md:gap-2 px-2 md:px-3 py-1 md:py-1.5 bg-green-600 text-white rounded hover:bg-green-700 transition-colors text-[11px] md:text-sm"
                                >
                                    <Plus size={14} className="md:w-4 md:h-4" />
                                    Add Item
                                </button>
                            </div>

                            {/* Scrollable table container with max height for 3 rows */}
                            <div className="border border-slate-200 dark:border-slate-700 rounded w-full max-w-[calc(100vw-20px)] lg:max-w-[calc(100vw-300px)]" style={{
                                maxHeight: '230px',
                                WebkitOverflowScrolling: 'touch',
                                overflowX: 'scroll',
                                overflowY: 'scroll',
                                display: 'block'
                            }}>
                                <table ref={tableRef} className="border-collapse" style={{ width: 'max-content', minWidth: '1500px', whiteSpace: 'nowrap' }}>
                                    <thead className="bg-slate-50 dark:bg-slate-800 sticky top-0 z-10" style={{ display: 'table-header-group' }}>
                                        <tr style={{ display: 'table-row' }}>
                                            <th className="text-left p-0.5 md:p-1.5 text-[9px] sm:text-[10px] md:text-xs font-semibold text-slate-700 dark:text-slate-300 border-b border-r border-slate-200 dark:border-slate-700 overflow-hidden" style={{ display: 'table-cell', minWidth: '50px', width: '50px', position: 'relative', textOverflow: 'ellipsis' }}>S.No<div onMouseDown={(e) => handleMouseDown(e, 0)} style={{ position: 'absolute', right: 0, top: 0, bottom: 0, width: '5px', cursor: 'col-resize', userSelect: 'none' }}></div></th>
                                            {/* <th className="text-left p-0.5 md:p-1.5 text-[9px] sm:text-[10px] md:text-xs font-semibold text-slate-700 dark:text-slate-300 border-b border-r border-slate-200 dark:border-slate-700 overflow-hidden" style={{ display: 'table-cell', minWidth: '100px', width: '100px', position: 'relative', textOverflow: 'ellipsis' }}>P.M. Code<div onMouseDown={(e) => handleMouseDown(e, 1)} style={{ position: 'absolute', right: 0, top: 0, bottom: 0, width: '5px', cursor: 'col-resize', userSelect: 'none' }}></div></th>
                    <th className="text-left p-0.5 md:p-1.5 text-[9px] sm:text-[10px] md:text-xs font-semibold text-slate-700 dark:text-slate-300 border-b border-slate-200 dark:border-slate-700 overflow-hidden" style={{ display: 'table-cell', minWidth: '120px', width: '120px', position: 'relative', textOverflow: 'ellipsis' }}>Product Code<div onMouseDown={(e) => handleMouseDown(e, 2)} style={{ position: 'absolute', right: 0, top: 0, bottom: 0, width: '5px', cursor: 'col-resize', userSelect: 'none' }}></div></th>
                    <th className="text-left p-0.5 md:p-1.5 text-[9px] sm:text-[10px] md:text-xs font-semibold text-slate-700 dark:text-slate-300 border-b border-slate-200 dark:border-slate-700 overflow-hidden" style={{ display: 'table-cell', minWidth: '150px', width: '150px', position: 'relative', textOverflow: 'ellipsis' }}>Particular<div onMouseDown={(e) => handleMouseDown(e, 3)} style={{ position: 'absolute', right: 0, top: 0, bottom: 0, width: '5px', cursor: 'col-resize', userSelect: 'none' }}></div></th>
                    <th className="text-left p-0.5 md:p-1.5 text-[9px] sm:text-[10px] md:text-xs font-semibold text-slate-700 dark:text-slate-300 border-b border-slate-200 dark:border-slate-700 overflow-hidden" style={{ display: 'table-cell', minWidth: '150px', width: '150px', position: 'relative', textOverflow: 'ellipsis' }}>Narration<div onMouseDown={(e) => handleMouseDown(e, 4)} style={{ position: 'absolute', right: 0, top: 0, bottom: 0, width: '5px', cursor: 'col-resize', userSelect: 'none' }}></div></th> */}
                                            <th className="text-left p-0.5 md:p-1.5 text-[9px] sm:text-[10px] md:text-xs font-semibold text-slate-700 dark:text-slate-300 border-b border-slate-200 dark:border-slate-700 overflow-hidden" style={{ display: 'table-cell', minWidth: '150px', width: '150px', position: 'relative', textOverflow: 'ellipsis' }}>Item Name<div onMouseDown={(e) => handleMouseDown(e, 1)} style={{ position: 'absolute', right: 0, top: 0, bottom: 0, width: '5px', cursor: 'col-resize', userSelect: 'none' }}></div></th>
                                            <th className="text-left p-0.5 md:p-1.5 text-[9px] sm:text-[10px] md:text-xs font-semibold text-slate-700 dark:text-slate-300 border-b border-slate-200 dark:border-slate-700 overflow-hidden" style={{ display: 'table-cell', minWidth: '120px', width: '120px', position: 'relative', textOverflow: 'ellipsis' }}>Item Code<div onMouseDown={(e) => handleMouseDown(e, 2)} style={{ position: 'absolute', right: 0, top: 0, bottom: 0, width: '5px', cursor: 'col-resize', userSelect: 'none' }}></div></th>
                                            <th className="text-left p-0.5 md:p-1.5 text-[9px] sm:text-[10px] md:text-xs font-semibold text-slate-700 dark:text-slate-300 border-b border-slate-200 dark:border-slate-700 overflow-hidden" style={{ display: 'table-cell', minWidth: '150px', width: '150px', position: 'relative', textOverflow: 'ellipsis' }}>Description<div onMouseDown={(e) => handleMouseDown(e, 3)} style={{ position: 'absolute', right: 0, top: 0, bottom: 0, width: '5px', cursor: 'col-resize', userSelect: 'none' }}></div></th>
                                            <th className="text-left p-0.5 md:p-1.5 text-[9px] sm:text-[10px] md:text-xs font-semibold text-slate-700 dark:text-slate-300 border-b border-slate-200 dark:border-slate-700 overflow-hidden" style={{ display: 'table-cell', minWidth: '90px', width: '90px', position: 'relative', textOverflow: 'ellipsis' }}>Is Service?<div onMouseDown={(e) => handleMouseDown(e, 4)} style={{ position: 'absolute', right: 0, top: 0, bottom: 0, width: '5px', cursor: 'col-resize', userSelect: 'none' }}></div></th>
                                            <th className="text-left p-0.5 md:p-1.5 text-[9px] sm:text-[10px] md:text-xs font-semibold text-slate-700 dark:text-slate-300 border-b border-slate-200 dark:border-slate-700 overflow-hidden" style={{ display: 'table-cell', minWidth: '150px', width: '150px', position: 'relative', textOverflow: 'ellipsis' }}>Group Name<div onMouseDown={(e) => handleMouseDown(e, 5)} style={{ position: 'absolute', right: 0, top: 0, bottom: 0, width: '5px', cursor: 'col-resize', userSelect: 'none' }}></div></th>
                                            <th className="text-left p-0.5 md:p-1.5 text-[9px] sm:text-[10px] md:text-xs font-semibold text-slate-700 dark:text-slate-300 border-b border-slate-200 dark:border-slate-700 overflow-hidden" style={{ display: 'table-cell', minWidth: '100px', width: '100px', position: 'relative', textOverflow: 'ellipsis' }}>HSN Code<div onMouseDown={(e) => handleMouseDown(e, 6)} style={{ position: 'absolute', right: 0, top: 0, bottom: 0, width: '5px', cursor: 'col-resize', userSelect: 'none' }}></div></th>
                                            {/* <th className="text-right p-0.5 md:p-1.5 text-[9px] sm:text-[10px] md:text-xs font-semibold text-slate-700 dark:text-slate-300 border-b border-slate-200 dark:border-slate-700 overflow-hidden" style={{ display: 'table-cell', minWidth: '80px', width: '80px', position: 'relative', textOverflow: 'ellipsis' }}>Free Qty<div onMouseDown={(e) => handleMouseDown(e, 7)} style={{ position: 'absolute', right: 0, top: 0, bottom: 0, width: '5px', cursor: 'col-resize', userSelect: 'none' }}></div></th> */}
                                            <th className="text-right p-0.5 md:p-1.5 text-[9px] sm:text-[10px] md:text-xs font-semibold text-slate-700 dark:text-slate-300 border-b border-slate-200 dark:border-slate-700 overflow-hidden" style={{ display: 'table-cell', minWidth: '80px', width: '80px', position: 'relative', textOverflow: 'ellipsis' }}>Qty<div onMouseDown={(e) => handleMouseDown(e, 7)} style={{ position: 'absolute', right: 0, top: 0, bottom: 0, width: '5px', cursor: 'col-resize', userSelect: 'none' }}></div></th>
                                            <th className="text-left p-0.5 md:p-1.5 text-[9px] sm:text-[10px] md:text-xs font-semibold text-slate-700 dark:text-slate-300 border-b border-slate-200 dark:border-slate-700 overflow-hidden" style={{ display: 'table-cell', minWidth: '80px', width: '80px', position: 'relative', textOverflow: 'ellipsis' }}>Unit<div onMouseDown={(e) => handleMouseDown(e, 8)} style={{ position: 'absolute', right: 0, top: 0, bottom: 0, width: '5px', cursor: 'col-resize', userSelect: 'none' }}></div></th>
                                            <th className="text-right p-0.5 md:p-1.5 text-[9px] sm:text-[10px] md:text-xs font-semibold text-slate-700 dark:text-slate-300 border-b border-slate-200 dark:border-slate-700 overflow-hidden" style={{ display: 'table-cell', minWidth: '100px', width: '100px', position: 'relative', textOverflow: 'ellipsis' }}>Rate<div onMouseDown={(e) => handleMouseDown(e, 9)} style={{ position: 'absolute', right: 0, top: 0, bottom: 0, width: '5px', cursor: 'col-resize', userSelect: 'none' }}></div></th>
                                            <th className="text-right p-0.5 md:p-1.5 text-[9px] sm:text-[10px] md:text-xs font-semibold text-slate-700 dark:text-slate-300 border-b border-slate-200 dark:border-slate-700 overflow-hidden" style={{ display: 'table-cell', minWidth: '80px', width: '80px', position: 'relative', textOverflow: 'ellipsis' }}>Disc %<div onMouseDown={(e) => handleMouseDown(e, 10)} style={{ position: 'absolute', right: 0, top: 0, bottom: 0, width: '5px', cursor: 'col-resize', userSelect: 'none' }}></div></th>
                                            <th className="text-right p-0.5 md:p-1.5 text-[9px] sm:text-[10px] md:text-xs font-semibold text-slate-700 dark:text-slate-300 border-b border-slate-200 dark:border-slate-700 overflow-hidden" style={{ display: 'table-cell', minWidth: '100px', width: '100px', position: 'relative', textOverflow: 'ellipsis' }}>Disc Amt<div onMouseDown={(e) => handleMouseDown(e, 11)} style={{ position: 'absolute', right: 0, top: 0, bottom: 0, width: '5px', cursor: 'col-resize', userSelect: 'none' }}></div></th>
                                            <th className="text-right p-0.5 md:p-1.5 text-[9px] sm:text-[10px] md:text-xs font-semibold text-slate-700 dark:text-slate-300 border-b border-slate-200 dark:border-slate-700 whitespace-nowrap" style={{ display: 'table-cell' }}>Basic Amt<div onMouseDown={(e) => handleMouseDown(e, 12)} style={{ position: 'absolute', right: 0, top: 0, bottom: 0, width: '5px', cursor: 'col-resize', userSelect: 'none' }}></div></th>
                                            {/* <th className="text-left p-0.5 md:p-1.5 text-[9px] sm:text-[10px] md:text-xs font-semibold text-slate-700 dark:text-slate-300 border-b border-slate-200 dark:border-slate-700 whitespace-nowrap" style={{ display: 'table-cell' }}>Packing Ref<div onMouseDown={(e) => handleMouseDown(e, 13)} style={{ position: 'absolute', right: 0, top: 0, bottom: 0, width: '5px', cursor: 'col-resize', userSelect: 'none' }}></div></th>
                    <th className="text-right p-0.5 md:p-1.5 text-[9px] sm:text-[10px] md:text-xs font-semibold text-slate-700 dark:text-slate-300 border-b border-slate-200 dark:border-slate-700 whitespace-nowrap" style={{ display: 'table-cell' }}>No Of Pallet<div onMouseDown={(e) => handleMouseDown(e, 14)} style={{ position: 'absolute', right: 0, top: 0, bottom: 0, width: '5px', cursor: 'col-resize', userSelect: 'none' }}></div></th>
                    <th className="text-right p-0.5 md:p-1.5 text-[9px] sm:text-[10px] md:text-xs font-semibold text-slate-700 dark:text-slate-300 border-b border-slate-200 dark:border-slate-700 whitespace-nowrap" style={{ display: 'table-cell' }}>No Of Carton<div onMouseDown={(e) => handleMouseDown(e, 15)} style={{ position: 'absolute', right: 0, top: 0, bottom: 0, width: '5px', cursor: 'col-resize', userSelect: 'none' }}></div></th>
                    <th className="text-right p-0.5 md:p-1.5 text-[9px] sm:text-[10px] md:text-xs font-semibold text-slate-700 dark:text-slate-300 border-b border-slate-200 dark:border-slate-700 whitespace-nowrap" style={{ display: 'table-cell' }}>Unit Per Carton<div onMouseDown={(e) => handleMouseDown(e, 16)} style={{ position: 'absolute', right: 0, top: 0, bottom: 0, width: '5px', cursor: 'col-resize', userSelect: 'none' }}></div></th>
                    <th className="text-right p-0.5 md:p-1.5 text-[9px] sm:text-[10px] md:text-xs font-semibold text-slate-700 dark:text-slate-300 border-b border-slate-200 dark:border-slate-700 whitespace-nowrap" style={{ display: 'table-cell' }}>Net Weight<div onMouseDown={(e) => handleMouseDown(e, 17)} style={{ position: 'absolute', right: 0, top: 0, bottom: 0, width: '5px', cursor: 'col-resize', userSelect: 'none' }}></div></th>
                    <th className="text-right p-0.5 md:p-1.5 text-[9px] sm:text-[10px] md:text-xs font-semibold text-slate-700 dark:text-slate-300 border-b border-slate-200 dark:border-slate-700 whitespace-nowrap" style={{ display: 'table-cell' }}>Gross Weight<div onMouseDown={(e) => handleMouseDown(e, 18)} style={{ position: 'absolute', right: 0, top: 0, bottom: 0, width: '5px', cursor: 'col-resize', userSelect: 'none' }}></div></th> */}
                                            {/* GST % Column - Removed as per requirement */}
                                            {/* <th className="text-right p-0.5 md:p-1.5 text-[9px] sm:text-[10px] md:text-xs font-semibold text-slate-700 dark:text-slate-300 border-b border-slate-200 dark:border-slate-700 whitespace-nowrap" style={{ display: 'table-cell' }}>GST %<div onMouseDown={(e) => handleMouseDown(e, 13)} style={{ position: 'absolute', right: 0, top: 0, bottom: 0, width: '5px', cursor: 'col-resize', userSelect: 'none' }}></div></th> */}

                                            {/* Fixed Tax Columns (Always Visible) */}
                                            <th className="text-right p-0.5 md:p-1.5 text-[9px] sm:text-[10px] md:text-xs font-semibold text-slate-700 dark:text-slate-300 border-b border-slate-200 dark:border-slate-700 whitespace-nowrap" style={{ display: 'table-cell' }}>CGST %<div onMouseDown={(e) => handleMouseDown(e, 14)} style={{ position: 'absolute', right: 0, top: 0, bottom: 0, width: '5px', cursor: 'col-resize', userSelect: 'none' }}></div></th>
                                            <th className="text-right p-0.5 md:p-1.5 text-[9px] sm:text-[10px] md:text-xs font-semibold text-slate-700 dark:text-slate-300 border-b border-slate-200 dark:border-slate-700 whitespace-nowrap" style={{ display: 'table-cell' }}>SGST %<div onMouseDown={(e) => handleMouseDown(e, 15)} style={{ position: 'absolute', right: 0, top: 0, bottom: 0, width: '5px', cursor: 'col-resize', userSelect: 'none' }}></div></th>
                                            <th className="text-right p-0.5 md:p-1.5 text-[9px] sm:text-[10px] md:text-xs font-semibold text-slate-700 dark:text-slate-300 border-b border-slate-200 dark:border-slate-700 whitespace-nowrap" style={{ display: 'table-cell' }}>IGST %<div onMouseDown={(e) => handleMouseDown(e, 16)} style={{ position: 'absolute', right: 0, top: 0, bottom: 0, width: '5px', cursor: 'col-resize', userSelect: 'none' }}></div></th>
                                            <th className="text-right p-0.5 md:p-1.5 text-[9px] sm:text-[10px] md:text-xs font-semibold text-slate-700 dark:text-slate-300 border-b border-slate-200 dark:border-slate-700 whitespace-nowrap" style={{ display: 'table-cell' }}>CGST Amt<div onMouseDown={(e) => handleMouseDown(e, 17)} style={{ position: 'absolute', right: 0, top: 0, bottom: 0, width: '5px', cursor: 'col-resize', userSelect: 'none' }}></div></th>
                                            <th className="text-right p-0.5 md:p-1.5 text-[9px] sm:text-[10px] md:text-xs font-semibold text-slate-700 dark:text-slate-300 border-b border-slate-200 dark:border-slate-700 whitespace-nowrap" style={{ display: 'table-cell' }}>SGST Amt<div onMouseDown={(e) => handleMouseDown(e, 18)} style={{ position: 'absolute', right: 0, top: 0, bottom: 0, width: '5px', cursor: 'col-resize', userSelect: 'none' }}></div></th>
                                            <th className="text-right p-0.5 md:p-1.5 text-[9px] sm:text-[10px] md:text-xs font-semibold text-slate-700 dark:text-slate-300 border-b border-slate-200 dark:border-slate-700 whitespace-nowrap" style={{ display: 'table-cell' }}>IGST Amt<div onMouseDown={(e) => handleMouseDown(e, 19)} style={{ position: 'absolute', right: 0, top: 0, bottom: 0, width: '5px', cursor: 'col-resize', userSelect: 'none' }}></div></th>

                                            <th className="text-right p-0.5 md:p-1.5 text-[9px] sm:text-[10px] md:text-xs font-semibold text-slate-700 dark:text-slate-300 border-b border-slate-200 dark:border-slate-700 whitespace-nowrap" style={{ display: 'table-cell' }}>Tax Amt<div onMouseDown={(e) => handleMouseDown(e, 20)} style={{ position: 'absolute', right: 0, top: 0, bottom: 0, width: '5px', cursor: 'col-resize', userSelect: 'none' }}></div></th>
                                            <th className="text-right p-0.5 md:p-1.5 text-[9px] sm:text-[10px] md:text-xs font-semibold text-slate-700 dark:text-slate-300 border-b border-slate-200 dark:border-slate-700 whitespace-nowrap" style={{ display: 'table-cell' }}>Taxable Amt<div onMouseDown={(e) => handleMouseDown(e, 21)} style={{ position: 'absolute', right: 0, top: 0, bottom: 0, width: '5px', cursor: 'col-resize', userSelect: 'none' }}></div></th>
                                            <th className="text-right p-0.5 md:p-1.5 text-[9px] sm:text-[10px] md:text-xs font-semibold text-slate-700 dark:text-slate-300 border-b border-slate-200 dark:border-slate-700 whitespace-nowrap" style={{ display: 'table-cell' }}>Total Amt<div onMouseDown={(e) => handleMouseDown(e, 22)} style={{ position: 'absolute', right: 0, top: 0, bottom: 0, width: '5px', cursor: 'col-resize', userSelect: 'none' }}></div></th>
                                            {/* <th className="text-left p-0.5 md:p-1.5 text-[9px] sm:text-[10px] md:text-xs font-semibold text-slate-700 dark:text-slate-300 border-b border-slate-200 dark:border-slate-700 whitespace-nowrap" style={{ display: 'table-cell' }}>PO No<div onMouseDown={(e) => handleMouseDown(e, 23)} style={{ position: 'absolute', right: 0, top: 0, bottom: 0, width: '5px', cursor: 'col-resize', userSelect: 'none' }}></div></th>
                    <th className="text-left p-0.5 md:p-1.5 text-[9px] sm:text-[10px] md:text-xs font-semibold text-slate-700 dark:text-slate-300 border-b border-slate-200 dark:border-slate-700 whitespace-nowrap" style={{ display: 'table-cell' }}>PO Date<div onMouseDown={(e) => handleMouseDown(e, 24)} style={{ position: 'absolute', right: 0, top: 0, bottom: 0, width: '5px', cursor: 'col-resize', userSelect: 'none' }}></div></th> */}
                                            {/* <th className="text-left p-0.5 md:p-1.5 text-[9px] sm:text-[10px] md:text-xs font-semibold text-slate-700 dark:text-slate-300 border-b border-slate-200 dark:border-slate-700 whitespace-nowrap" style={{ display: 'table-cell' }}>Sales Order No<div onMouseDown={(e) => handleMouseDown(e, 25)} style={{ position: 'absolute', right: 0, top: 0, bottom: 0, width: '5px', cursor: 'col-resize', userSelect: 'none' }}></div></th>
                    <th className="text-left p-0.5 md:p-1.5 text-[9px] sm:text-[10px] md:text-xs font-semibold text-slate-700 dark:text-slate-300 border-b border-slate-200 dark:border-slate-700 whitespace-nowrap" style={{ display: 'table-cell' }}>Job Booking No<div onMouseDown={(e) => handleMouseDown(e, 26)} style={{ position: 'absolute', right: 0, top: 0, bottom: 0, width: '5px', cursor: 'col-resize', userSelect: 'none' }}></div></th>
                    <th className="text-left p-0.5 md:p-1.5 text-[9px] sm:text-[10px] md:text-xs font-semibold text-slate-700 dark:text-slate-300 border-b border-slate-200 dark:border-slate-700 whitespace-nowrap" style={{ display: 'table-cell' }}>Delivery Note No<div onMouseDown={(e) => handleMouseDown(e, 27)} style={{ position: 'absolute', right: 0, top: 0, bottom: 0, width: '5px', cursor: 'col-resize', userSelect: 'none' }}></div></th>
                    <th className="text-left p-0.5 md:p-1.5 text-[9px] sm:text-[10px] md:text-xs font-semibold text-slate-700 dark:text-slate-300 border-b border-slate-200 dark:border-slate-700 whitespace-nowrap" style={{ display: 'table-cell' }}>Delivery Note Date<div onMouseDown={(e) => handleMouseDown(e, 28)} style={{ position: 'absolute', right: 0, top: 0, bottom: 0, width: '5px', cursor: 'col-resize', userSelect: 'none' }}></div></th>
                    <th className="text-left p-0.5 md:p-1.5 text-[9px] sm:text-[10px] md:text-xs font-semibold text-slate-700 dark:text-slate-300 border-b border-slate-200 dark:border-slate-700 whitespace-nowrap" style={{ display: 'table-cell' }}>Batch Name<div onMouseDown={(e) => handleMouseDown(e, 29)} style={{ position: 'absolute', right: 0, top: 0, bottom: 0, width: '5px', cursor: 'col-resize', userSelect: 'none' }}></div></th>
                    <th className="text-left p-0.5 md:p-1.5 text-[9px] sm:text-[10px] md:text-xs font-semibold text-slate-700 dark:text-slate-300 border-b border-slate-200 dark:border-slate-700 whitespace-nowrap" style={{ display: 'table-cell' }}>Batch No<div onMouseDown={(e) => handleMouseDown(e, 30)} style={{ position: 'absolute', right: 0, top: 0, bottom: 0, width: '5px', cursor: 'col-resize', userSelect: 'none' }}></div></th>
                    <th className="text-left p-0.5 md:p-1.5 text-[9px] sm:text-[10px] md:text-xs font-semibold text-slate-700 dark:text-slate-300 border-b border-slate-200 dark:border-slate-700 whitespace-nowrap" style={{ display: 'table-cell' }}>Supp.Batch No<div onMouseDown={(e) => handleMouseDown(e, 31)} style={{ position: 'absolute', right: 0, top: 0, bottom: 0, width: '5px', cursor: 'col-resize', userSelect: 'none' }}></div></th>
                    <th className="text-left p-0.5 md:p-1.5 text-[9px] sm:text-[10px] md:text-xs font-semibold text-slate-700 dark:text-slate-300 border-b border-slate-200 dark:border-slate-700 whitespace-nowrap" style={{ display: 'table-cell' }}>Transaction ID<div onMouseDown={(e) => handleMouseDown(e, 32)} style={{ position: 'absolute', right: 0, top: 0, bottom: 0, width: '5px', cursor: 'col-resize', userSelect: 'none' }}></div></th> */}
                                            <th className="text-center p-0.5 md:p-1.5 text-[9px] sm:text-[10px] md:text-xs font-semibold text-slate-700 dark:text-slate-300 border-b border-l border-slate-200 dark:border-slate-700" style={{ display: 'table-cell' }}>Action</th>
                                        </tr>
                                    </thead>
                                    <tbody style={{ display: 'table-row-group' }}>
                                        {invoiceItems.map((item, index) => (
                                            <tr key={`inv-row-${item.id}-${index}`} className="border-b border-slate-100 hover:bg-slate-50 dark:bg-slate-800" style={{ display: 'table-row' }}>
                                                {/* S.No */}
                                                <td className="p-0.5 md:p-1.5 text-[9px] sm:text-[10px] md:text-xs text-slate-700 dark:text-slate-300 whitespace-nowrap border-r border-slate-200 dark:border-slate-700" style={{ display: 'table-cell' }}>{index + 1}</td>

                                                {/* P.M. Code (Read-only) - HIDDEN */}
                                                {/* <td className="p-0.5 md:p-1.5 text-[9px] sm:text-[10px] md:text-xs text-slate-700 dark:text-slate-300 whitespace-nowrap bg-slate-50 dark:bg-slate-800" style={{ display: 'table-cell' }}>
                        {item.productMasterCode || ''}
                      </td> */}

                                                {/* Product Code - HIDDEN */}
                                                {/* <td className="p-1 md:p-1.5 overflow-hidden" style={{ display: 'table-cell' }}>
                        <input type="text" className="w-full p-0.5 md:p-1.5 border border-slate-200 dark:border-slate-700 rounded text-[9px] md:text-xs focus:ring-1 focus:ring-blue-500 outline-none" value={item.productCode || ''} onChange={(e) => handleItemChange(item.id, 'productCode', e.target.value)} placeholder="Product code" />
                      </td> */}

                                                {/* Particular (Job Name) - HIDDEN */}
                                                {/* <td className="p-1 md:p-1.5 overflow-hidden" style={{ display: 'table-cell' }}>
                        <input type="text" className="w-full p-0.5 md:p-1.5 border border-slate-200 dark:border-slate-700 rounded text-[9px] md:text-xs focus:ring-1 focus:ring-blue-500 outline-none" value={item.jobName || ''} onChange={(e) => handleItemChange(item.id, 'jobName', e.target.value)} placeholder="Particular" />
                      </td> */}

                                                {/* Narration - HIDDEN */}
                                                {/* <td className="p-1 md:p-1.5 overflow-hidden" style={{ display: 'table-cell' }}>
                        <input type="text" className="w-full p-0.5 md:p-1.5 border border-slate-200 dark:border-slate-700 rounded text-[9px] md:text-xs focus:ring-1 focus:ring-blue-500 outline-none" value={item.narration || ''} onChange={(e) => handleItemChange(item.id, 'narration', e.target.value)} placeholder="Narration" />
                      </td> */}

                                                {/* Item Name (Searchable Select, Text when selected) */}
                                                <td className="p-1 md:p-1.5 overflow-hidden" style={{ display: 'table-cell', minWidth: '150px' }}>
                                                    <select
                                                        className="w-full p-0.5 md:p-1.5 border border-slate-200 dark:border-slate-700 rounded text-[9px] md:text-xs focus:ring-1 focus:ring-blue-500 outline-none"
                                                        value={item.itemId ? item.itemId.toString() : ''}
                                                        onChange={(e) => handleItemChange(item.id, 'itemId', e.target.value)}
                                                    >
                                                        <option value="">Select Item</option>
                                                        {itemsList
                                                            .filter(i => {
                                                                const iId = (i?.id || i?.ItemID || i?.itemId);
                                                                if (!iId) return false;

                                                                // Condition 1: It is a Scrap Item
                                                                const isScrap = i.IsScrap === 1 || i.IsScrap === '1' || i.isScrap === true;

                                                                // Condition 2: OR It is the item currently selected in this specific row (preserve existing selection)
                                                                const isSelected = item.itemId && (iId.toString() === item.itemId.toString());

                                                                return isScrap || isSelected;
                                                            })
                                                            .map(i => (
                                                                <option key={i.id || i.ItemID || i.itemId} value={(i.id || i.ItemID || i.itemId).toString()}>
                                                                    {i.itemName || i.ItemName || i.name || 'Unknown Item'}
                                                                </option>
                                                            ))
                                                        }
                                                    </select>
                                                </td>

                                                {/* Item Code */}
                                                {/* Item Code (Read-Only) */}
                                                <td className="p-1 md:p-1.5 overflow-hidden" style={{ display: 'table-cell' }}>
                                                    <input type="text" readOnly className="w-full p-0.5 md:p-1.5 border border-slate-200 dark:border-slate-700 rounded text-[9px] md:text-xs bg-slate-50 dark:bg-slate-800 text-slate-500 focus:outline-none cursor-not-allowed" value={item.itemCode || ''} title="Item Code is read-only" />
                                                </td>

                                                {/* Description */}
                                                <td className="p-1 md:p-1.5 overflow-hidden" style={{ display: 'table-cell' }}>
                                                    <input type="text" className="w-full p-0.5 md:p-1.5 border border-slate-200 dark:border-slate-700 rounded text-[9px] md:text-xs focus:ring-1 focus:ring-blue-500 outline-none" value={item.description || ''} onChange={(e) => handleItemChange(item.id, 'description', e.target.value)} placeholder="Description" />
                                                </td>

                                                {/* Is Service */}
                                                <td className="p-1 md:p-1.5 overflow-hidden" style={{ display: 'table-cell' }}>
                                                    <select className="w-full p-0.5 md:p-1.5 border border-slate-200 dark:border-slate-700 rounded text-[9px] md:text-xs focus:ring-1 focus:ring-blue-500 outline-none" value={item.isService} onChange={(e) => handleItemChange(item.id, 'isService', e.target.value as 'Yes' | 'No')}>
                                                        <option value="No">No</option>
                                                        <option value="Yes">Yes</option>
                                                    </select>
                                                </td>

                                                {/* Group Name (HSN Group Dropdown) */}
                                                <td className="p-1 md:p-1.5 overflow-hidden" style={{ display: 'table-cell' }}>
                                                    <select
                                                        className="w-full p-0.5 md:p-1.5 border border-slate-200 dark:border-slate-700 rounded text-[9px] md:text-xs focus:ring-1 focus:ring-blue-500 outline-none"
                                                        value={item.productHSNName || ''}
                                                        onChange={(e) => handleHSNGroupChange(item.id, e.target.value)}
                                                    >
                                                        <option value="">-- Select Group --</option>
                                                        {hsnGroups.map((group: any, index: number) => (
                                                            <option key={`${group.productHSNID}-${index}`} value={group.productHSNName}>
                                                                {group.productHSNName}
                                                            </option>
                                                        ))}
                                                    </select>
                                                </td>

                                                {/* HSN Code (Read-only, Auto-filled) */}
                                                <td className="p-1 md:p-1.5 text-[10px] md:text-xs text-slate-700 dark:text-slate-300 whitespace-nowrap bg-slate-50 dark:bg-slate-800 overflow-hidden" style={{ display: 'table-cell' }}>
                                                    {item.hsnCode || ''}
                                                </td>

                                                {/* Free Qty */}
                                                {/* <td className="p-1 md:p-1.5 overflow-hidden" style={{ display: 'table-cell' }}>
                        <input type="number" step="0.01" className="w-full p-1 md:p-1.5 border border-slate-200 dark:border-slate-700 rounded text-right text-[10px] md:text-xs focus:ring-1 focus:ring-blue-500 outline-none" value={item.freeQuantity || ''} onChange={(e) => handleItemChange(item.id, 'freeQuantity', parseFloat(e.target.value) || 0)} />
                      </td> */}

                                                {/* Qty */}
                                                <td className="p-1 md:p-1.5 overflow-hidden" style={{ display: 'table-cell' }}>
                                                    <input type="number" step="0.01" className="w-full p-1 md:p-1.5 border border-slate-200 dark:border-slate-700 rounded text-right text-[10px] md:text-xs focus:ring-1 focus:ring-blue-500 outline-none" value={item.quantity || ''} onChange={(e) => handleItemChange(item.id, 'quantity', parseFloat(e.target.value) || 0)} />
                                                    {/* Show dual unit display for PCS items */}
                                                    {item.originalStockUnit?.toUpperCase() === 'PCS' && item.wtPerPacking && (
                                                        <div className="text-[8px] text-green-600 mt-0.5">
                                                            {item.unit === 'KG'
                                                                ? `= ${((item.quantity || 0) / item.wtPerPacking).toFixed(2)} PCS`
                                                                : `= ${((item.quantity || 0) * item.wtPerPacking).toFixed(2)} KG`
                                                            }
                                                        </div>
                                                    )}
                                                </td>

                                                {/* Unit */}
                                                <td className="p-1 md:p-1.5 overflow-hidden" style={{ display: 'table-cell' }}>
                                                    <select className="w-full p-0.5 md:p-1.5 border border-slate-200 dark:border-slate-700 rounded text-[9px] md:text-xs focus:ring-1 focus:ring-blue-500 outline-none" value={item.unit?.toUpperCase() || ''} onChange={(e) => handleItemChange(item.id, 'unit', e.target.value)}>
                                                        <option value="KG">KG</option>
                                                        <option value="SHEET">SHEET</option>
                                                        <option value="PCS">PCS</option>
                                                        <option value="Per Unit">Per Unit</option>
                                                        <option value="1000 Unit">1000 Unit</option>
                                                        <option value="100 Unit">100 Unit</option>
                                                        <option value="MTR">MTR</option>
                                                        <option value="Numbers">Numbers</option>
                                                    </select>
                                                </td>

                                                {/* Rate */}
                                                <td className="p-1 md:p-1.5 overflow-hidden" style={{ display: 'table-cell' }}>
                                                    <input type="number" step="0.01" className="w-full p-1 md:p-1.5 border border-slate-200 dark:border-slate-700 rounded text-right text-[10px] md:text-xs focus:ring-1 focus:ring-blue-500 outline-none" value={item.rate || ''} onChange={(e) => handleItemChange(item.id, 'rate', parseFloat(e.target.value) || 0)} />
                                                </td>

                                                {/* Disc % */}
                                                <td className="p-1 md:p-1.5 overflow-hidden" style={{ display: 'table-cell' }}>
                                                    <input type="number" step="0.01" className="w-full p-1 md:p-1.5 border border-slate-200 dark:border-slate-700 rounded text-right text-[10px] md:text-xs focus:ring-1 focus:ring-blue-500 outline-none" value={item.discountPercent || 0} onChange={(e) => handleItemChange(item.id, 'discountPercent', parseFloat(e.target.value) || 0)} />
                                                </td>

                                                {/* Disc Amt (Calculated) */}
                                                <td className="p-1 md:p-1.5 text-right text-[10px] md:text-xs text-slate-700 dark:text-slate-300 whitespace-nowrap bg-slate-50 dark:bg-slate-800 overflow-hidden" style={{ display: 'table-cell' }}>
                                                    {formatNumber(item.discountAmount || 0)}
                                                </td>

                                                {/* Basic Amt (Calculated) */}
                                                <td className="p-1 md:p-1.5 text-right text-[10px] md:text-xs font-semibold text-slate-800 dark:text-slate-100 whitespace-nowrap bg-slate-50 dark:bg-slate-800 overflow-hidden" style={{ display: 'table-cell' }}>
                                                    {formatNumber(item.basicAmount || 0)}
                                                </td>

                                                {/* Packing Reference - HIDDEN */}
                                                {/* <td className="p-1 md:p-1.5 overflow-hidden" style={{ display: 'table-cell' }}>
                        <input type="text" className="w-full p-0.5 md:p-1.5 border border-slate-200 dark:border-slate-700 rounded text-[9px] md:text-xs focus:ring-1 focus:ring-blue-500 outline-none" value={item.packingReference || ''} onChange={(e) => handleItemChange(item.id, 'packingReference', e.target.value)} />
                      </td> */}

                                                {/* No Of Pallet - HIDDEN */}
                                                {/* <td className="p-1 md:p-1.5 overflow-hidden" style={{ display: 'table-cell' }}>
                        <input type="number" className="w-full p-1 md:p-1.5 border border-slate-200 dark:border-slate-700 rounded text-right text-[10px] md:text-xs focus:ring-1 focus:ring-blue-500 outline-none" value={item.noOfPallet || ''} onChange={(e) => handleItemChange(item.id, 'noOfPallet', parseFloat(e.target.value) || 0)} />
                      </td> */}

                                                {/* No Of Carton - HIDDEN */}
                                                {/* <td className="p-1 md:p-1.5 overflow-hidden" style={{ display: 'table-cell' }}>
                        <input type="number" className="w-full p-1 md:p-1.5 border border-slate-200 dark:border-slate-700 rounded text-right text-[10px] md:text-xs focus:ring-1 focus:ring-blue-500 outline-none" value={item.issueOuterCarton || ''} onChange={(e) => handleItemChange(item.id, 'issueOuterCarton', parseFloat(e.target.value) || 0)} />
                      </td> */}

                                                {/* Unit Per Carton - HIDDEN */}
                                                {/* <td className="p-1 md:p-1.5 overflow-hidden" style={{ display: 'table-cell' }}>
                        <input type="number" className="w-full p-1 md:p-1.5 border border-slate-200 dark:border-slate-700 rounded text-right text-[10px] md:text-xs focus:ring-1 focus:ring-blue-500 outline-none" value={item.innerCarton || ''} onChange={(e) => handleItemChange(item.id, 'innerCarton', parseFloat(e.target.value) || 0)} />
                      </td> */}

                                                {/* Net Weight - HIDDEN */}
                                                {/* <td className="p-1 md:p-1.5 overflow-hidden" style={{ display: 'table-cell' }}>
                        <input type="number" step="0.01" className="w-full p-1 md:p-1.5 border border-slate-200 dark:border-slate-700 rounded text-right text-[10px] md:text-xs focus:ring-1 focus:ring-blue-500 outline-none" value={item.netWeight || ''} onChange={(e) => handleItemChange(item.id, 'netWeight', parseFloat(e.target.value) || 0)} />
                      </td> */}

                                                {/* Gross Weight - HIDDEN */}
                                                {/* <td className="p-1 md:p-1.5 overflow-hidden" style={{ display: 'table-cell' }}>
                        <input type="number" step="0.01" className="w-full p-1 md:p-1.5 border border-slate-200 dark:border-slate-700 rounded text-right text-[10px] md:text-xs focus:ring-1 focus:ring-blue-500 outline-none" value={item.grossWeight || ''} onChange={(e) => handleItemChange(item.id, 'grossWeight', parseFloat(e.target.value) || 0)} />
                      </td> */}

                                                {/* GST % - Removed */}
                                                {/* <td className="p-1 md:p-1.5 overflow-hidden" style={{ display: 'table-cell' }}>
                        <input type="number" step="0.01" className="w-full p-1 md:p-1.5 border border-slate-200 dark:border-slate-700 rounded text-right text-[10px] md:text-xs focus:ring-1 focus:ring-blue-500 outline-none" value={item.gstTaxPercentage || ''} onChange={(e) => handleItemChange(item.id, 'gstTaxPercentage', parseFloat(e.target.value) || 0)} />
                      </td> */}

                                                {!isInterState ? (
                                                    <>
                                                        {/* CGST % - Active */}
                                                        <td className="p-1 md:p-1.5 text-right text-[10px] md:text-xs text-slate-700 dark:text-slate-300 whitespace-nowrap bg-slate-50 dark:bg-slate-800 overflow-hidden" style={{ display: 'table-cell' }}>
                                                            {item.cgstTaxPercentage || 0}
                                                        </td>
                                                        {/* SGST % - Active */}
                                                        <td className="p-1 md:p-1.5 text-right text-[10px] md:text-xs text-slate-700 dark:text-slate-300 whitespace-nowrap bg-slate-50 dark:bg-slate-800 overflow-hidden" style={{ display: 'table-cell' }}>
                                                            {item.sgstTaxPercentage || 0}
                                                        </td>
                                                        {/* IGST % - Inactive */}
                                                        <td className="p-1 md:p-1.5 text-right text-[10px] md:text-xs text-slate-400 whitespace-nowrap bg-slate-50 dark:bg-slate-800 overflow-hidden" style={{ display: 'table-cell' }}>
                                                            -
                                                        </td>
                                                        {/* CGST Amt - Active */}
                                                        <td className="p-1 md:p-1.5 text-right text-[10px] md:text-xs text-slate-700 dark:text-slate-300 whitespace-nowrap bg-slate-50 dark:bg-slate-800 overflow-hidden" style={{ display: 'table-cell' }}>
                                                            {formatNumber(item.cgstAmt || 0)}
                                                        </td>
                                                        {/* SGST Amt - Active */}
                                                        <td className="p-1 md:p-1.5 text-right text-[10px] md:text-xs text-slate-700 dark:text-slate-300 whitespace-nowrap bg-slate-50 dark:bg-slate-800 overflow-hidden" style={{ display: 'table-cell' }}>
                                                            {formatNumber(item.sgstAmt || 0)}
                                                        </td>
                                                        {/* IGST Amt - Inactive */}
                                                        <td className="p-1 md:p-1.5 text-right text-[10px] md:text-xs text-slate-400 whitespace-nowrap bg-slate-50 dark:bg-slate-800 overflow-hidden" style={{ display: 'table-cell' }}>
                                                            -
                                                        </td>
                                                    </>
                                                ) : (
                                                    <>
                                                        {/* CGST % - Inactive */}
                                                        <td className="p-1 md:p-1.5 text-right text-[10px] md:text-xs text-slate-400 whitespace-nowrap bg-slate-50 dark:bg-slate-800 overflow-hidden" style={{ display: 'table-cell' }}>
                                                            -
                                                        </td>
                                                        {/* SGST % - Inactive */}
                                                        <td className="p-1 md:p-1.5 text-right text-[10px] md:text-xs text-slate-400 whitespace-nowrap bg-slate-50 dark:bg-slate-800 overflow-hidden" style={{ display: 'table-cell' }}>
                                                            -
                                                        </td>
                                                        {/* IGST % - Active */}
                                                        <td className="p-1 md:p-1.5 text-right text-[10px] md:text-xs text-slate-700 dark:text-slate-300 whitespace-nowrap bg-slate-50 dark:bg-slate-800 overflow-hidden" style={{ display: 'table-cell' }}>
                                                            {item.igstTaxPercentage || 0}
                                                        </td>
                                                        {/* CGST Amt - Inactive */}
                                                        <td className="p-1 md:p-1.5 text-right text-[10px] md:text-xs text-slate-400 whitespace-nowrap bg-slate-50 dark:bg-slate-800 overflow-hidden" style={{ display: 'table-cell' }}>
                                                            -
                                                        </td>
                                                        {/* SGST Amt - Inactive */}
                                                        <td className="p-1 md:p-1.5 text-right text-[10px] md:text-xs text-slate-400 whitespace-nowrap bg-slate-50 dark:bg-slate-800 overflow-hidden" style={{ display: 'table-cell' }}>
                                                            -
                                                        </td>
                                                        {/* IGST Amt - Active */}
                                                        <td className="p-1 md:p-1.5 text-right text-[10px] md:text-xs text-slate-700 dark:text-slate-300 whitespace-nowrap bg-slate-50 dark:bg-slate-800 overflow-hidden" style={{ display: 'table-cell' }}>
                                                            {formatNumber(item.igstAmt || 0)}
                                                        </td>
                                                    </>
                                                )}

                                                {/* Tax Amt (Calculated) */}
                                                <td className="p-1 md:p-1.5 text-right text-[10px] md:text-xs text-slate-700 dark:text-slate-300 whitespace-nowrap bg-slate-50 dark:bg-slate-800 overflow-hidden" style={{ display: 'table-cell' }}>
                                                    {formatNumber(item.taxAmount || 0)}
                                                </td>

                                                {/* Taxable Amt (Calculated) */}
                                                <td className="p-1 md:p-1.5 text-right text-[10px] md:text-xs text-slate-700 dark:text-slate-300 whitespace-nowrap bg-slate-50 dark:bg-slate-800 overflow-hidden" style={{ display: 'table-cell' }}>
                                                    {formatNumber(item.taxableAmount || 0)}
                                                </td>

                                                {/* Total Amt (Calculated) */}
                                                <td className="p-1 md:p-1.5 text-right text-[10px] md:text-xs font-bold text-blue-700 whitespace-nowrap bg-blue-50 overflow-hidden" style={{ display: 'table-cell' }}>
                                                    {formatNumber(item.amount)}
                                                </td>

                                                {/* PO No - HIDDEN */}
                                                {/* <td className="p-1 md:p-1.5 overflow-hidden" style={{ display: 'table-cell' }}>
                        <input type="text" className="w-full p-0.5 md:p-1.5 border border-slate-200 dark:border-slate-700 rounded text-[9px] md:text-xs focus:ring-1 focus:ring-blue-500 outline-none" value={item.poNo || ''} onChange={(e) => handleItemChange(item.id, 'poNo', e.target.value)} />
                      </td> */}

                                                {/* PO Date - HIDDEN */}
                                                {/* <td className="p-1 md:p-1.5 overflow-hidden" style={{ display: 'table-cell' }}>
                        <input type="date" className="w-full p-0.5 md:p-1.5 border border-slate-200 dark:border-slate-700 rounded text-[9px] md:text-xs focus:ring-1 focus:ring-blue-500 outline-none" value={item.poDate || ''} onChange={(e) => handleItemChange(item.id, 'poDate', e.target.value)} />
                      </td> */}

                                                {/* Sales Order No (Read-only) - HIDDEN */}
                                                {/* <td className="p-1 md:p-1.5 text-[10px] md:text-xs text-slate-700 dark:text-slate-300 whitespace-nowrap bg-slate-50 dark:bg-slate-800 overflow-hidden" style={{ display: 'table-cell' }}>
                        {item.salesOrderNo || ''}
                      </td> */}

                                                {/* Job Booking No (Read-only) - HIDDEN */}
                                                {/* <td className="p-1 md:p-1.5 text-[10px] md:text-xs text-slate-700 dark:text-slate-300 whitespace-nowrap bg-slate-50 dark:bg-slate-800 overflow-hidden" style={{ display: 'table-cell' }}>
                        {item.jobBookingNo || ''}
                      </td> */}

                                                {/* Delivery Note No (Read-only) - HIDDEN */}
                                                {/* <td className="p-1 md:p-1.5 text-[10px] md:text-xs text-slate-700 dark:text-slate-300 whitespace-nowrap bg-slate-50 dark:bg-slate-800 overflow-hidden" style={{ display: 'table-cell' }}>
                        {item.deliveryNoteNo || ''}
                      </td> */}

                                                {/* Delivery Note Date (Read-only) - HIDDEN */}
                                                {/* <td className="p-1 md:p-1.5 text-[10px] md:text-xs text-slate-700 dark:text-slate-300 whitespace-nowrap bg-slate-50 dark:bg-slate-800 overflow-hidden" style={{ display: 'table-cell' }}>
                        {item.deliveryNoteDate || ''}
                      </td> */}

                                                {/* Batch Name - HIDDEN */}
                                                {/* <td className="p-1 md:p-1.5 overflow-hidden" style={{ display: 'table-cell' }}>
                        <input type="text" className="w-full p-0.5 md:p-1.5 border border-slate-200 dark:border-slate-700 rounded text-[9px] md:text-xs focus:ring-1 focus:ring-blue-500 outline-none" value={item.batchName || ''} onChange={(e) => handleItemChange(item.id, 'batchName', e.target.value)} />
                      </td> */}

                                                {/* Batch No - HIDDEN */}
                                                {/* <td className="p-1 md:p-1.5 overflow-hidden" style={{ display: 'table-cell' }}>
                        <input type="text" className="w-full p-0.5 md:p-1.5 border border-slate-200 dark:border-slate-700 rounded text-[9px] md:text-xs focus:ring-1 focus:ring-blue-500 outline-none" value={item.batchNo || ''} onChange={(e) => handleItemChange(item.id, 'batchNo', e.target.value)} />
                      </td> */}

                                                {/* Supplier Batch No - HIDDEN */}
                                                {/* <td className="p-1 md:p-1.5 overflow-hidden" style={{ display: 'table-cell' }}>
                        <input type="text" className="w-full p-0.5 md:p-1.5 border border-slate-200 dark:border-slate-700 rounded text-[9px] md:text-xs focus:ring-1 focus:ring-blue-500 outline-none" value={item.supplierBatchNo || ''} onChange={(e) => handleItemChange(item.id, 'supplierBatchNo', e.target.value)} />
                      </td> */}

                                                {/* Transaction ID (Read-only) - HIDDEN */}
                                                {/* <td className="p-1 md:p-1.5 text-[10px] md:text-xs text-slate-700 dark:text-slate-300 whitespace-nowrap bg-slate-50 dark:bg-slate-800 overflow-hidden" style={{ display: 'table-cell' }}>
                        {item.transactionID || ''}
                      </td> */}

                                                {/* Action */}
                                                <td className="p-0.5 md:p-1.5 text-center border-l border-slate-200 dark:border-slate-700" style={{ display: 'table-cell' }}>
                                                    <button onClick={() => removeItem(item.id)} className="p-1 text-red-600 hover:bg-red-50 rounded transition-colors" title="Delete Item">
                                                        <Trash2 size={12} className="md:w-4 md:h-4" />
                                                    </button>
                                                </td>
                                            </tr>
                                        ))}
                                        {invoiceItems.length === 0 && (
                                            <tr style={{ display: 'table-row' }}>
                                                <td colSpan={45} className="p-6 md:p-8 text-center text-slate-400 text-[10px] md:text-xs" style={{ display: 'table-cell' }}>
                                                    No items added. Click "Add Item" to add items to the invoice.
                                                </td>
                                            </tr>
                                        )}
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        {/* Amount Summary */}
                        <div className="grid grid-cols-3 lg:grid-cols-6 gap-1.5 lg:pr-[10px]" style={{ display: 'grid' }}>

                            <div>
                                <label className="block text-[9px] sm:text-[10px] md:text-xs font-medium text-slate-700 dark:text-slate-300 mb-0.5 truncate">Basic Amount</label>
                                <input
                                    type="number"
                                    step="0.01"
                                    className="w-full p-1 sm:p-1 md:p-2 border border-slate-200 dark:border-slate-700 rounded bg-slate-50 dark:bg-slate-800 text-[9px] sm:text-[10px] md:text-xs"
                                    value={formData.basicAmount}
                                    readOnly
                                />
                            </div>

                            <div>
                                <label className="block text-[9px] sm:text-[10px] md:text-xs font-medium text-slate-700 dark:text-slate-300 mb-0.5 truncate">Total Tax</label>
                                <input
                                    type="number"
                                    step="0.01"
                                    className="w-full p-1 sm:p-1 md:p-2 border border-slate-200 dark:border-slate-700 rounded bg-slate-50 dark:bg-slate-800 text-[9px] sm:text-[10px] md:text-xs"
                                    value={formData.totalTax}
                                    readOnly
                                />
                            </div>

                            <div>
                                <label className="block text-[9px] sm:text-[10px] md:text-xs font-medium text-slate-700 dark:text-slate-300 mb-0.5 truncate">TCS (%)</label>
                                <input
                                    type="number"
                                    step="0.01"
                                    className="w-full p-1 sm:p-1 md:p-2 border border-slate-200 dark:border-slate-700 rounded focus:ring-1 focus:ring-blue-500 outline-none text-[9px] sm:text-[10px] md:text-xs"
                                    value={formData.tcsPercent}
                                    onChange={(e) => setFormData({ ...formData, tcsPercent: parseFloat(e.target.value) || 0 })}
                                />
                            </div>

                            <div>
                                <label className="block text-[9px] sm:text-[10px] md:text-xs font-medium text-slate-700 dark:text-slate-300 mb-0.5 truncate">TCS Amount</label>
                                <input
                                    type="number"
                                    step="0.01"
                                    className="w-full p-1.5 md:p-2 border border-slate-200 dark:border-slate-700 rounded bg-slate-50 dark:bg-slate-800 text-[11px] md:text-xs"
                                    value={formData.tcsAmount}
                                    readOnly
                                />
                            </div>

                            <div>
                                <label className="block text-[9px] sm:text-[10px] md:text-xs font-medium text-slate-700 dark:text-slate-300 mb-0.5 truncate">Net Amount</label>
                                <input
                                    type="number"
                                    step="0.01"
                                    className="w-full p-1.5 md:p-2 border border-slate-200 dark:border-slate-700 rounded bg-blue-50 font-bold text-blue-700 text-[11px] md:text-xs"
                                    value={formData.netAmount}
                                    readOnly
                                />
                            </div>

                        </div>

                        <div className="my-2 sm:my-3 md:my-4 border-t border-slate-200 dark:border-slate-700"></div>

                        {/* Tax Calculation & Other Fields */}
                        <div>
                            <div className="grid grid-cols-1 lg:grid-cols-2 gap-4 md:gap-6">

                                {/* Left: Tax Table */}
                                <div>
                                    {/* Add Tax Ledger Controls - Outside Table */}
                                    <div className="flex gap-2 mb-3">
                                        <div className="flex-1">
                                            <SearchableSelect
                                                options={taxLedgers.map(ledger => ({
                                                    value: ledger.LedgerID.toString(),
                                                    label: ledger.LedgerName
                                                }))}
                                                value={selectedTaxLedger}
                                                onChange={(value) => setSelectedTaxLedger(value)}
                                                placeholder="Select Tax Ledger"
                                            />
                                        </div>
                                        <button
                                            onClick={addTaxLedger}
                                            className="px-3 md:px-4 py-1.5 md:py-2 bg-green-600 text-white rounded hover:bg-green-700 transition-colors text-[11px] md:text-sm flex items-center gap-1"
                                        >
                                            <Plus size={14} className="md:w-4 md:h-4" />
                                            Add
                                        </button>
                                    </div>

                                    {/* Tax Calculation Table */}
                                    <div className="overflow-x-auto border border-gray-200 rounded-lg">
                                        <table className="min-w-full divide-y divide-gray-200">
                                            <thead className="bg-slate-50 dark:bg-slate-800">
                                                <tr>
                                                    <th className="text-left p-1.5 md:p-2 text-[10px] md:text-xs font-semibold text-slate-700 dark:text-slate-300 border-b border-slate-200 dark:border-slate-700">Tax Ledger</th>
                                                    <th className="text-right p-1.5 md:p-2 text-[10px] md:text-xs font-semibold text-slate-700 dark:text-slate-300 border-b border-slate-200 dark:border-slate-700">Tax %</th>
                                                    <th className="text-center p-1.5 md:p-2 text-[10px] md:text-xs font-semibold text-slate-700 dark:text-slate-300 border-b border-slate-200 dark:border-slate-700">Calc ON</th>
                                                    <th className="text-center p-1.5 md:p-2 text-[10px] md:text-xs font-semibold text-slate-700 dark:text-slate-300 border-b border-slate-200 dark:border-slate-700">GST</th>
                                                    <th className="text-right p-1.5 md:p-2 text-[10px] md:text-xs font-semibold text-slate-700 dark:text-slate-300 border-b border-slate-200 dark:border-slate-700">In Amt</th>
                                                    <th className="text-right p-1.5 md:p-2 text-[10px] md:text-xs font-semibold text-slate-700 dark:text-slate-300 border-b border-slate-200 dark:border-slate-700">Amount</th>
                                                    <th className="text-center p-1.5 md:p-2 text-[10px] md:text-xs font-semibold text-slate-700 dark:text-slate-300 border-b border-slate-200 dark:border-slate-700"></th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {taxCalculationRows.map((row) => (
                                                    <tr key={row.id} className="border-b border-slate-100 hover:bg-slate-50 dark:bg-slate-800">
                                                        <td className="p-1.5 md:p-2 text-[10px] md:text-xs text-slate-700 dark:text-slate-300">{row.ledgerName}</td>

                                                        {/* Editable Tax % */}
                                                        <td className="p-1.5 md:p-2 text-right text-[10px] md:text-xs text-slate-700 dark:text-slate-300">
                                                            <input
                                                                type="number"
                                                                step="0.01"
                                                                className="w-full p-1 border border-slate-200 dark:border-slate-700 rounded text-right text-[10px] md:text-xs"
                                                                value={row.taxRate}
                                                                onChange={(e) => {
                                                                    const newRate = parseFloat(e.target.value) || 0;
                                                                    setTaxCalculationRows(taxCalculationRows.map(r => {
                                                                        if (r.id === row.id) {
                                                                            const newAmount = r.isManualAmount ? r.amount : (r.inAmount * newRate) / 100;
                                                                            return { ...r, taxRate: newRate, amount: newAmount };
                                                                        }
                                                                        return r;
                                                                    }));
                                                                }}
                                                            />
                                                        </td>

                                                        <td className="p-1.5 md:p-2 text-center text-[10px] md:text-xs text-slate-700 dark:text-slate-300">{row.calculationOn}</td>
                                                        <td className="p-1.5 md:p-2 text-center text-[10px] md:text-xs text-slate-700 dark:text-slate-300">
                                                            {row.gstApplicable ? 'âœ“' : ''}
                                                        </td>

                                                        {/* In Amt Checkbox */}
                                                        <td className="p-1.5 md:p-2 text-center">
                                                            <input
                                                                type="checkbox"
                                                                checked={row.isManualAmount}
                                                                onChange={(e) => {
                                                                    setTaxCalculationRows(taxCalculationRows.map(r => {
                                                                        if (r.id === row.id) {
                                                                            return { ...r, isManualAmount: e.target.checked };
                                                                        }
                                                                        return r;
                                                                    }));
                                                                }}
                                                                className="w-4 h-4 cursor-pointer"
                                                            />
                                                        </td>

                                                        {/* Editable Amount (only if In Amt checkbox is checked) */}
                                                        <td className="p-1.5 md:p-2 text-right text-[10px] md:text-xs font-semibold text-slate-800 dark:text-slate-100">
                                                            {row.isManualAmount ? (
                                                                <input
                                                                    type="number"
                                                                    step="0.01"
                                                                    className="w-full p-1 border border-slate-200 dark:border-slate-700 rounded text-right text-[10px] md:text-xs font-semibold"
                                                                    value={row.amount}
                                                                    onChange={(e) => {
                                                                        const newAmount = parseFloat(e.target.value) || 0;
                                                                        setTaxCalculationRows(taxCalculationRows.map(r => {
                                                                            if (r.id === row.id) {
                                                                                return { ...r, amount: newAmount };
                                                                            }
                                                                            return r;
                                                                        }));
                                                                    }}
                                                                />
                                                            ) : (
                                                                formatNumber(row.amount)
                                                            )}
                                                        </td>

                                                        <td className="p-1.5 md:p-2 text-center">
                                                            <button
                                                                onClick={() => {
                                                                    setTaxCalculationRows(taxCalculationRows.filter(r => r.id !== row.id));
                                                                }}
                                                                className="text-red-600 hover:text-red-800 text-[10px] md:text-xs underline"
                                                            >
                                                                Del
                                                            </button>
                                                        </td>
                                                    </tr>
                                                ))}
                                                {taxCalculationRows.length === 0 && (
                                                    <tr>
                                                        <td colSpan={7} className="p-3 md:p-4 text-center text-slate-400 text-[10px] md:text-xs">
                                                            No tax rows added
                                                        </td>
                                                    </tr>
                                                )}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>

                                {/* Right: Other Fields */}
                                <div>
                                    <div className="grid grid-cols-2 gap-2 md:gap-3">

                                        <div>
                                            <label className="block text-[9px] sm:text-[10px] md:text-xs font-medium text-slate-700 dark:text-slate-300 mb-0.5 truncate">Total Qty</label>
                                            <input
                                                type="number"
                                                step="0.01"
                                                className="w-full p-1 sm:p-1 md:p-2 border border-slate-200 dark:border-slate-700 rounded bg-slate-50 dark:bg-slate-800 text-[9px] sm:text-[10px] md:text-xs"
                                                value={formData.totalDispatchedQty}
                                                readOnly
                                            />
                                        </div>

                                        <div>
                                            <label className="block text-[9px] sm:text-[10px] md:text-xs font-medium text-slate-700 dark:text-slate-300 mb-0.5 truncate">Net Wt (KG)</label>
                                            <input
                                                type="number"
                                                step="0.01"
                                                className="w-full p-1 sm:p-1 md:p-2 border border-slate-200 dark:border-slate-700 rounded bg-slate-50 dark:bg-slate-800 text-[9px] sm:text-[10px] md:text-xs"
                                                value={formData.netWeight}
                                                readOnly
                                            />
                                        </div>

                                        <div>
                                            <label className="block text-[9px] sm:text-[10px] md:text-xs font-medium text-slate-700 dark:text-slate-300 mb-0.5 truncate">Gross Wt (KG)</label>
                                            <input
                                                type="number"
                                                step="0.01"
                                                className="w-full p-1 sm:p-1 md:p-2 border border-slate-200 dark:border-slate-700 rounded bg-slate-50 dark:bg-slate-800 text-[9px] sm:text-[10px] md:text-xs"
                                                value={formData.grossWeight}
                                                readOnly
                                            />
                                        </div>

                                        <div>
                                            <label className="block text-[9px] sm:text-[10px] md:text-xs font-medium text-slate-700 dark:text-slate-300 mb-0.5 truncate">Round Off</label>
                                            <input
                                                type="number"
                                                step="0.01"
                                                className="w-full p-1 sm:p-1 md:p-2 border border-slate-200 dark:border-slate-700 rounded focus:ring-1 focus:ring-blue-500 outline-none text-[9px] sm:text-[10px] md:text-xs"
                                                value={formData.roundOffAc}
                                                onChange={(e) => setFormData({ ...formData, roundOffAc: parseFloat(e.target.value) || 0 })}
                                            />
                                        </div>

                                    </div>
                                </div>

                            </div>
                        </div>

                        <div className="my-2 sm:my-3 md:my-4 border-t border-slate-200 dark:border-slate-700"></div>

                        {/* Transport & Other Details */}
                        <div className="grid grid-cols-3 lg:grid-cols-6 gap-1.5 lg:pr-[10px]" style={{ display: 'grid' }}>

                            {/* Inv Ref No */}
                            <div>
                                <label className="block text-[9px] sm:text-[10px] md:text-xs font-medium text-slate-700 dark:text-slate-300 mb-0.5 truncate">Inv Ref No</label>
                                <input
                                    type="text"
                                    className="w-full p-1 sm:p-1 md:p-2 border border-slate-200 dark:border-slate-700 rounded bg-slate-50 dark:bg-slate-800 text-[9px] sm:text-[10px] md:text-xs"
                                    value={formData.invoiceRefNo}
                                    title={formData.invoiceRefNo}
                                    readOnly
                                />
                            </div>

                            {/* Transporter */}
                            <div>
                                <label className="block text-[9px] sm:text-[10px] md:text-xs font-medium text-slate-700 dark:text-slate-300 mb-0.5 truncate">Transporter</label>
                                <SearchableSelect
                                    options={transporters.map(transporter => ({
                                        value: (transporter.LedgerID || transporter.TransporterID)?.toString() || '',
                                        label: transporter.TransporterName || transporter.LedgerName || ''
                                    }))}
                                    value={formData.transporterId}
                                    onChange={handleTransporterChange}
                                    placeholder="Select Transporter"
                                    className="text-[9px] sm:text-[10px] md:text-xs"
                                />
                            </div>

                            {/* Vehicle No */}
                            <div>
                                <label className="block text-[9px] sm:text-[10px] md:text-xs font-medium text-slate-700 dark:text-slate-300 mb-0.5 truncate">Vehicle No</label>
                                <input
                                    type="text"
                                    className="w-full p-1 sm:p-1 md:p-2 border border-slate-200 dark:border-slate-700 rounded focus:ring-1 focus:ring-blue-500 outline-none text-[9px] sm:text-[10px] md:text-xs"
                                    value={formData.vehicleNo}
                                    title={formData.vehicleNo}
                                    onChange={(e) => setFormData({ ...formData, vehicleNo: e.target.value })}
                                    placeholder="Vehicle no"
                                />
                            </div>

                            {/* Transport Mode */}
                            <div>
                                <label className="block text-[9px] sm:text-[10px] md:text-xs font-medium text-slate-700 dark:text-slate-300 mb-0.5 truncate">Transport Mode</label>
                                <select
                                    className="w-full p-1 sm:p-1 md:p-2 border border-slate-200 dark:border-slate-700 rounded focus:ring-1 focus:ring-blue-500 outline-none text-[9px] sm:text-[10px] md:text-xs"
                                    value={formData.modeOfTransport}
                                    onChange={(e) => setFormData({ ...formData, modeOfTransport: e.target.value })}
                                >
                                    <option value="">Select</option>
                                    <option value="Road">Road</option>
                                    <option value="Rail">Rail</option>
                                    <option value="Air">Air</option>
                                    <option value="Ship">Ship</option>
                                </select>
                            </div>

                            {/* POD No */}
                            <div>
                                <label className="block text-[9px] sm:text-[10px] md:text-xs font-medium text-slate-700 dark:text-slate-300 mb-0.5 truncate">POD No</label>
                                <input
                                    type="text"
                                    className="w-full p-1 sm:p-1 md:p-2 border border-slate-200 dark:border-slate-700 rounded focus:ring-1 focus:ring-blue-500 outline-none text-[9px] sm:text-[10px] md:text-xs"
                                    value={formData.podNo}
                                    title={formData.podNo}
                                    onChange={(e) => setFormData({ ...formData, podNo: e.target.value })}
                                    placeholder="POD no"
                                />
                            </div>

                            {/* Distance */}
                            <div>
                                <label className="block text-[9px] sm:text-[10px] md:text-xs font-medium text-slate-700 dark:text-slate-300 mb-0.5 truncate">Distance (KM)</label>
                                <input
                                    type="text"
                                    className="w-full p-1 sm:p-1 md:p-2 border border-slate-200 dark:border-slate-700 rounded focus:ring-1 focus:ring-blue-500 outline-none text-[9px] sm:text-[10px] md:text-xs"
                                    value={formData.distance}
                                    title={formData.distance}
                                    onChange={(e) => setFormData({ ...formData, distance: e.target.value })}
                                    placeholder="Distance"
                                />
                            </div>

                            {/* E-Way Bill */}
                            <div>
                                <label className="block text-[9px] sm:text-[10px] md:text-xs font-medium text-slate-700 dark:text-slate-300 mb-0.5 truncate">E-Way Bill</label>
                                <input
                                    type="text"
                                    className="w-full p-1 sm:p-1 md:p-2 border border-slate-200 dark:border-slate-700 rounded focus:ring-1 focus:ring-blue-500 outline-none text-[9px] sm:text-[10px] md:text-xs"
                                    value={formData.eWayBill}
                                    title={formData.eWayBill}
                                    onChange={(e) => setFormData({ ...formData, eWayBill: e.target.value })}
                                    placeholder="E-way bill"
                                />
                            </div>

                            {/* E-Way Date */}
                            <div>
                                <label className="block text-[9px] sm:text-[10px] md:text-xs font-medium text-slate-700 dark:text-slate-300 mb-0.5 truncate">E-Way Date</label>
                                <input
                                    type="date"
                                    className="w-full p-1 sm:p-1 md:p-2 border border-slate-200 dark:border-slate-700 rounded focus:ring-1 focus:ring-blue-500 outline-none text-[9px] sm:text-[10px] md:text-xs"
                                    value={formData.eWayBillDate}
                                    onChange={(e) => setFormData({ ...formData, eWayBillDate: e.target.value })}
                                />
                            </div>

                            {/* Payment Terms */}
                            <div>
                                <label className="block text-[9px] sm:text-[10px] md:text-xs font-medium text-slate-700 dark:text-slate-300 mb-0.5 truncate">Payment Terms</label>
                                <input
                                    type="text"
                                    className="w-full p-1 sm:p-1 md:p-2 border border-slate-200 dark:border-slate-700 rounded focus:ring-1 focus:ring-blue-500 outline-none text-[9px] sm:text-[10px] md:text-xs"
                                    value={formData.paymentTerms}
                                    title={formData.paymentTerms}
                                    onChange={(e) => setFormData({ ...formData, paymentTerms: e.target.value })}
                                    placeholder="Net 30 days"
                                />
                            </div>

                            {/* Remark */}
                            <div className="col-span-3 lg:col-span-3">
                                <label className="block text-[9px] sm:text-[10px] md:text-xs font-medium text-slate-700 dark:text-slate-300 mb-0.5 truncate">Remark</label>
                                <textarea
                                    rows={2}
                                    className="w-full p-1 sm:p-1 md:p-2 border border-slate-200 dark:border-slate-700 rounded focus:ring-1 focus:ring-blue-500 outline-none resize-none text-[9px] sm:text-[10px] md:text-xs"
                                    value={formData.remark}
                                    onChange={(e) => setFormData({ ...formData, remark: e.target.value })}
                                    placeholder="Enter any remarks or notes"
                                />
                            </div>

                        </div>

                    </div>


                </div>

                {/* Fixed Bottom Action Bar for Mobile/Tablet - REMOVED to avoid conflict with Nav Bar */}
                {/* Buttons are now back in the Sticky Header */}
            </div>
            {/* Validation Modal */}
            {validationError && (
                <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
                    <div className="bg-white dark:bg-slate-900 rounded-lg shadow-xl max-w-md w-full overflow-hidden animate-in fade-in zoom-in duration-200 border border-slate-200 dark:border-slate-700">
                        <div className="p-6">
                            <div className="flex flex-col items-center text-center gap-4">
                                <div className="w-12 h-12 rounded-full bg-red-100 dark:bg-red-900/30 flex items-center justify-center text-red-600 dark:text-red-400">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>
                                </div>
                                <h3 className="text-lg font-semibold text-slate-900 dark:text-slate-100">
                                    Required Field Missing
                                </h3>
                                <p className="text-sm text-slate-600 dark:text-slate-400">
                                    {validationError}
                                </p>
                            </div>
                        </div>
                        <div className="bg-slate-50 dark:bg-slate-800/50 p-4 flex justify-center">
                            <button
                                onClick={() => setValidationError(null)}
                                className="min-w-[100px] px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 font-medium text-sm transition-colors shadow-sm"
                            >
                                OK
                            </button>
                        </div>
                    </div>
                </div>
            )}
        </Layout>
    );
};